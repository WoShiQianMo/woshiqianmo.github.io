<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>03-多线程与高并发 | Hexo</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a></nav></header><main style="flex-direction: row-reverse"><article><div id="post-bg"><div id="post-title"><h1>03-多线程与高并发</h1><hr></div><div id="post-content"><h5 id="1-AQS-CLH"><a href="#1-AQS-CLH" class="headerlink" title="1.AQS (CLH)"></a>1.AQS (CLH)</h5><p><img src="C:\Users\QianMo\AppData\Roaming\Typora\typora-user-images\1618155612105.png" alt="AQS核心结构"></p>
<h5 id="2-CAS新类型锁-–-ReentrantLock"><a href="#2-CAS新类型锁-–-ReentrantLock" class="headerlink" title="2. CAS新类型锁 – ReentrantLock"></a>2. CAS新类型锁 – ReentrantLock</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * reentrantlock用于替代synchronized</span><br><span class="hljs-comment"> * 本例中由于m1锁定this,只有m1执行完毕的时候,m2才能执行</span><br><span class="hljs-comment"> * 这里是复习synchronized最原始的语义</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReentrantLock</span> </span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">m1</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++) &#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				e.printStackTrace();<br>			&#125;<br>			System.out.println(i);<br>			<span class="hljs-keyword">if</span>(i == <span class="hljs-number">2</span>) m2();<br>		&#125;<br>		<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">m2</span><span class="hljs-params">()</span> </span>&#123;<br>		System.out.println(<span class="hljs-string">&quot;m2 ...&quot;</span>);<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		ReentrantLock rl = <span class="hljs-keyword">new</span> ReentrantLock();<br>		<span class="hljs-keyword">new</span> Thread(rl::m1).start();<br>		<span class="hljs-keyword">try</span> &#123;<br>			TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>		<span class="hljs-comment">//new Thread(rl::m2).start();</span><br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * reentrantlock用于替代synchronized</span><br><span class="hljs-comment"> * 由于m1锁定this,只有m1执行完毕的时候,m2才能执行</span><br><span class="hljs-comment"> * 这里是复习synchronized最原始的语义</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用reentrantlock可以完成同样的功能</span><br><span class="hljs-comment"> * 需要注意的是，必须要必须要必须要手动释放锁（重要的事情说三遍）</span><br><span class="hljs-comment"> * 使用syn锁定的话如果遇到异常，jvm会自动释放锁，但是lock必须手动释放锁，因此经常在finally中进行锁的释放</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReentrantLock</span> </span>&#123;<br>	Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br><br>	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">m1</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">try</span> &#123;<br>			lock.lock(); <span class="hljs-comment">//synchronized(this)</span><br>			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>				TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br><br>				System.out.println(i);<br>			&#125;<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">finally</span> &#123;<br>			lock.unlock();<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">m2</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">try</span> &#123;<br>			lock.lock();<br>			System.out.println(<span class="hljs-string">&quot;m2 ...&quot;</span>);<br>		&#125; <span class="hljs-keyword">finally</span> &#123;<br>			lock.unlock();<br>		&#125;<br><br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		ReentrantLock rl = <span class="hljs-keyword">new</span> ReentrantLock();<br>		<span class="hljs-keyword">new</span> Thread(rl::m1).start();<br>		<span class="hljs-keyword">try</span> &#123;<br>			TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>		<span class="hljs-keyword">new</span> Thread(rl::m2).start();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * reentrantlock用于替代synchronized</span><br><span class="hljs-comment"> * 由于m1锁定this,只有m1执行完毕的时候,m2才能执行</span><br><span class="hljs-comment"> * 这里是复习synchronized最原始的语义</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用reentrantlock可以完成同样的功能</span><br><span class="hljs-comment"> * 需要注意的是，必须要必须要必须要手动释放锁（重要的事情说三遍）</span><br><span class="hljs-comment"> * 使用syn锁定的话如果遇到异常，jvm会自动释放锁，但是lock必须手动释放锁，因此经常在finally中进行锁的释放</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用reentrantlock可以进行“尝试锁定”tryLock，这样无法锁定，或者在指定时间内无法锁定，线程可以决定是否继续等待</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReentrantLock</span> </span>&#123;<br>	Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br><br>	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">m1</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">try</span> &#123;<br>			lock.lock();<br>			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>				TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br><br>				System.out.println(i);<br>			&#125;<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">finally</span> &#123;<br>			lock.unlock();<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 使用tryLock进行尝试锁定，不管锁定与否，方法都将继续执行</span><br><span class="hljs-comment">	 * 可以根据tryLock的返回值来判定是否锁定</span><br><span class="hljs-comment">	 * 也可以指定tryLock的时间，由于tryLock(time)抛出异常，所以要注意unclock的处理，必须放到finally中</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">m2</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		boolean locked = lock.tryLock();</span><br><span class="hljs-comment">		System.out.println(&quot;m2 ...&quot; + locked);</span><br><span class="hljs-comment">		if(locked) lock.unlock();</span><br><span class="hljs-comment">		*/</span><br>		<br>		<span class="hljs-keyword">boolean</span> locked = <span class="hljs-keyword">false</span>;<br>		<br>		<span class="hljs-keyword">try</span> &#123;<br>			locked = lock.tryLock(<span class="hljs-number">5</span>, TimeUnit.SECONDS);<br>			System.out.println(<span class="hljs-string">&quot;m2 ...&quot;</span> + locked);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">finally</span> &#123;<br>			<span class="hljs-keyword">if</span>(locked) lock.unlock();<br>		&#125;<br>		<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		ReentrantLock rl = <span class="hljs-keyword">new</span> ReentrantLock();<br>		<span class="hljs-keyword">new</span> Thread(rl::m1).start();<br>		<span class="hljs-keyword">try</span> &#123;<br>			TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>		<span class="hljs-keyword">new</span> Thread(rl::m2).start();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * reentrantlock用于替代synchronized</span><br><span class="hljs-comment"> * 由于m1锁定this,只有m1执行完毕的时候,m2才能执行</span><br><span class="hljs-comment"> * 这里是复习synchronized最原始的语义</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用reentrantlock可以完成同样的功能</span><br><span class="hljs-comment"> * 需要注意的是，必须要必须要必须要手动释放锁（重要的事情说三遍）</span><br><span class="hljs-comment"> * 使用syn锁定的话如果遇到异常，jvm会自动释放锁，但是lock必须手动释放锁，因此经常在finally中进行锁的释放</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用reentrantlock可以进行“尝试锁定”tryLock，这样无法锁定，或者在指定时间内无法锁定，线程可以决定是否继续等待</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用ReentrantLock还可以调用lockInterruptibly方法，可以对线程interrupt方法做出响应，</span><br><span class="hljs-comment"> * 在一个线程等待锁的过程中，可以被打断</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><span class="hljs-keyword">import</span> java.util.function.Function;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReentrantLock</span> </span>&#123;<br>		<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>		<br>		<br>		Thread t1 = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				lock.lock();<br>				System.out.println(<span class="hljs-string">&quot;t1 start&quot;</span>);<br>				TimeUnit.SECONDS.sleep(Integer.MAX_VALUE);<br>				System.out.println(<span class="hljs-string">&quot;t1 end&quot;</span>);<br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				System.out.println(<span class="hljs-string">&quot;interrupted!&quot;</span>);<br>			&#125; <span class="hljs-keyword">finally</span> &#123;<br>				lock.unlock();<br>			&#125;<br>		&#125;);<br>		t1.start();<br>		<br>		Thread t2 = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-comment">//lock.lock();</span><br>				lock.lockInterruptibly(); <span class="hljs-comment">//可以对interrupt()方法做出响应</span><br>				System.out.println(<span class="hljs-string">&quot;t2 start&quot;</span>);<br>				TimeUnit.SECONDS.sleep(<span class="hljs-number">5</span>);<br>				System.out.println(<span class="hljs-string">&quot;t2 end&quot;</span>);<br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				System.out.println(<span class="hljs-string">&quot;interrupted!&quot;</span>);<br>			&#125; <span class="hljs-keyword">finally</span> &#123;<br>				lock.unlock();<br>			&#125;<br>		&#125;);<br>		t2.start();<br>		<br>		<span class="hljs-keyword">try</span> &#123;<br>			TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>		t2.interrupt(); <span class="hljs-comment">//打断线程2的等待</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="公平锁：先检查队列是否存在等待，存在就进入队列等待"><a href="#公平锁：先检查队列是否存在等待，存在就进入队列等待" class="headerlink" title="公平锁：先检查队列是否存在等待，存在就进入队列等待"></a>公平锁：先检查队列是否存在等待，存在就进入队列等待</h6><h6 id="非公平锁：不论是否存在等待，直接抢锁"><a href="#非公平锁：不论是否存在等待，直接抢锁" class="headerlink" title="非公平锁：不论是否存在等待，直接抢锁"></a>非公平锁：不论是否存在等待，直接抢锁</h6><ul>
<li>reentrantlock默认非公平锁</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * reentrantlock用于替代synchronized</span><br><span class="hljs-comment"> * 由于m1锁定this,只有m1执行完毕的时候,m2才能执行</span><br><span class="hljs-comment"> * 这里是复习synchronized最原始的语义</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用reentrantlock可以完成同样的功能</span><br><span class="hljs-comment"> * 需要注意的是，必须要必须要必须要手动释放锁（重要的事情说三遍）</span><br><span class="hljs-comment"> * 使用syn锁定的话如果遇到异常，jvm会自动释放锁，但是lock必须手动释放锁，因此经常在finally中进行锁的释放</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用reentrantlock可以进行“尝试锁定”tryLock，这样无法锁定，或者在指定时间内无法锁定，线程可以决定是否继续等待</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用ReentrantLock还可以调用lockInterruptibly方法，可以对线程interrupt方法做出响应，</span><br><span class="hljs-comment"> * 在一个线程等待锁的过程中，可以被打断</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * ReentrantLock还可以指定为公平锁</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReentrantLock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;<br>		<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ReentrantLock lock=<span class="hljs-keyword">new</span> ReentrantLock(<span class="hljs-keyword">true</span>); <span class="hljs-comment">//参数为true表示为公平锁，请对比输出结果</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">100</span>; i++) &#123;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span>&#123;<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">&quot;获得锁&quot;</span>);<br>            &#125;<span class="hljs-keyword">finally</span>&#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ReentrantLock rl=<span class="hljs-keyword">new</span> ReentrantLock();<br>        Thread th1=<span class="hljs-keyword">new</span> Thread(rl);<br>        Thread th2=<span class="hljs-keyword">new</span> Thread(rl);<br>        th1.start();<br>        th2.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-ReentrantLock-vs-synchronized"><a href="#3-ReentrantLock-vs-synchronized" class="headerlink" title="3. ReentrantLock vs synchronized"></a>3. ReentrantLock vs synchronized</h5><ul>
<li>cas vs sync   ReentrantLock 底层cas</li>
<li>trylock </li>
<li>lockinterupptibly  ReentrantLock 可以被打断</li>
<li>公平和非公平切换 ReentrantLock 可以选择公平非公平</li>
</ul>
<h5 id="4-CountDownLatch类"><a href="#4-CountDownLatch类" class="headerlink" title="4. CountDownLatch类"></a>4. CountDownLatch类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestCountDownLatch</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        usingJoin();<br>        usingCountDownLatch();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">usingCountDownLatch</span><span class="hljs-params">()</span> </span>&#123;<br>        Thread[] threads = <span class="hljs-keyword">new</span> Thread[<span class="hljs-number">100</span>];<br>        CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(threads.length);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;threads.length; i++) &#123;<br>            threads[i] = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">10000</span>; j++) result += j;<br>                latch.countDown();<br>            &#125;);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; threads.length; i++) &#123;<br>            threads[i].start();<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            latch.await();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        System.out.println(<span class="hljs-string">&quot;end latch&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">usingJoin</span><span class="hljs-params">()</span> </span>&#123;<br>        Thread[] threads = <span class="hljs-keyword">new</span> Thread[<span class="hljs-number">100</span>];<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;threads.length; i++) &#123;<br>            threads[i] = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">10000</span>; j++) result += j;<br>            &#125;);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; threads.length; i++) &#123;<br>            threads[i].start();<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; threads.length; i++) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                threads[i].join();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;end join&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="5-CyclicBarrier-可循环屏障"><a href="#5-CyclicBarrier-可循环屏障" class="headerlink" title="5.CyclicBarrier 可循环屏障"></a>5.CyclicBarrier 可循环屏障</h5><ul>
<li><p>等待线程数堆够要求，可以继续执行</p>
</li>
<li><p>限流（实际使用可能使用Guava RateLimiter）</p>
</li>
<li><p>复杂操作(顺序执行)</p>
<ul>
<li>数据库</li>
<li>网络</li>
<li>文件</li>
</ul>
</li>
<li><p>并发执行</p>
<ul>
<li>线程-数据库操作</li>
<li>线程-网络操作 </li>
</ul>
<p>等待所有完成以后继续执行</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.BrokenBarrierException;<br><span class="hljs-keyword">import</span> java.util.concurrent.CyclicBarrier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestCyclicBarrier</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">//CyclicBarrier barrier = new CyclicBarrier(20);</span><br><br>        CyclicBarrier barrier = <span class="hljs-keyword">new</span> CyclicBarrier(<span class="hljs-number">20</span>, () -&gt; System.out.println(<span class="hljs-string">&quot;满人&quot;</span>));<br><br>        <span class="hljs-comment">/*CyclicBarrier barrier = new CyclicBarrier(20, new Runnable() &#123;</span><br><span class="hljs-comment">            @Override</span><br><span class="hljs-comment">            public void run() &#123;</span><br><span class="hljs-comment">                System.out.println(&quot;满人，发车&quot;);</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">        &#125;);*/</span><br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">100</span>; i++) &#123;<br>                <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        barrier.await();<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                        e.printStackTrace();<br>                    &#125; <span class="hljs-keyword">catch</span> (BrokenBarrierException e) &#123;<br>                        e.printStackTrace();<br>                    &#125;<br>                &#125;).start();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="6-Phaser同步屏障"><a href="#6-Phaser同步屏障" class="headerlink" title="6. Phaser同步屏障"></a>6. Phaser同步屏障</h5><ul>
<li>按照不同阶段执行，同时共同几个人一起参与（遗传算法问题可能用到）先异步，后同步</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> java.util.concurrent.Phaser;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestPhaser</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> Random r = <span class="hljs-keyword">new</span> Random();<br>    <span class="hljs-keyword">static</span> MarriagePhaser phaser = <span class="hljs-keyword">new</span> MarriagePhaser();<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">milliSleep</span><span class="hljs-params">(<span class="hljs-keyword">int</span> milli)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.MILLISECONDS.sleep(milli);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        phaser.bulkRegister(<span class="hljs-number">5</span>);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> nameIndex = i;<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br><br>                Person p = <span class="hljs-keyword">new</span> Person(<span class="hljs-string">&quot;person &quot;</span> + nameIndex);<br>                p.arrive();<br>                phaser.arriveAndAwaitAdvance();<br><br>                p.eat();<br>                phaser.arriveAndAwaitAdvance();<br><br>                p.leave();<br>                phaser.arriveAndAwaitAdvance();<br>            &#125;).start();<br>        &#125;<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MarriagePhaser</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Phaser</span> </span>&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">onAdvance</span><span class="hljs-params">(<span class="hljs-keyword">int</span> phase, <span class="hljs-keyword">int</span> registeredParties)</span> </span>&#123;<br><br>            <span class="hljs-keyword">switch</span> (phase) &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                    System.out.println(<span class="hljs-string">&quot;所有人到齐了！&quot;</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    System.out.println(<span class="hljs-string">&quot;所有人吃完了！&quot;</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                    System.out.println(<span class="hljs-string">&quot;所有人离开了！&quot;</span>);<br>                    System.out.println(<span class="hljs-string">&quot;婚礼结束！&quot;</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>&#123;<br>        String name;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(String name)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.name = name;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">arrive</span><span class="hljs-params">()</span> </span>&#123;<br>            milliSleep(r.nextInt(<span class="hljs-number">1000</span>));<br>            System.out.printf(<span class="hljs-string">&quot;%s 到达现场！\n&quot;</span>, name);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span> </span>&#123;<br>            milliSleep(r.nextInt(<span class="hljs-number">1000</span>));<br>            System.out.printf(<span class="hljs-string">&quot;%s 吃完!\n&quot;</span>, name);<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">leave</span><span class="hljs-params">()</span> </span>&#123;<br>            milliSleep(r.nextInt(<span class="hljs-number">1000</span>));<br>            System.out.printf(<span class="hljs-string">&quot;%s 离开！\n&quot;</span>, name);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> java.util.concurrent.Phaser;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestPhaser2</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> Random r = <span class="hljs-keyword">new</span> Random();<br>    <span class="hljs-keyword">static</span> MarriagePhaser phaser = <span class="hljs-keyword">new</span> MarriagePhaser();<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">milliSleep</span><span class="hljs-params">(<span class="hljs-keyword">int</span> milli)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            TimeUnit.MILLISECONDS.sleep(milli);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        phaser.bulkRegister(<span class="hljs-number">7</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Person(<span class="hljs-string">&quot;p&quot;</span> + i)).start();<br>        &#125;<br>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Person(<span class="hljs-string">&quot;新郎&quot;</span>)).start();<br>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Person(<span class="hljs-string">&quot;新娘&quot;</span>)).start();<br><br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MarriagePhaser</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Phaser</span> </span>&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">onAdvance</span><span class="hljs-params">(<span class="hljs-keyword">int</span> phase, <span class="hljs-keyword">int</span> registeredParties)</span> </span>&#123;<br><br>            <span class="hljs-keyword">switch</span> (phase) &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                    System.out.println(<span class="hljs-string">&quot;所有人到齐了！&quot;</span> + registeredParties);<br>                    System.out.println();<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    System.out.println(<span class="hljs-string">&quot;所有人吃完了！&quot;</span> + registeredParties);<br>                    System.out.println();<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                    System.out.println(<span class="hljs-string">&quot;所有人离开了！&quot;</span> + registeredParties);<br>                    System.out.println();<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                    System.out.println(<span class="hljs-string">&quot;婚礼结束！新郎新娘抱抱！&quot;</span> + registeredParties);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;<br>        String name;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(String name)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.name = name;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">arrive</span><span class="hljs-params">()</span> </span>&#123;<br>            milliSleep(r.nextInt(<span class="hljs-number">1000</span>));<br>            System.out.printf(<span class="hljs-string">&quot;%s 到达现场！\n&quot;</span>, name);<br>            phaser.arriveAndAwaitAdvance();<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span> </span>&#123;<br>            milliSleep(r.nextInt(<span class="hljs-number">1000</span>));<br>            System.out.printf(<span class="hljs-string">&quot;%s 吃完!\n&quot;</span>, name);<br>            phaser.arriveAndAwaitAdvance();<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">leave</span><span class="hljs-params">()</span> </span>&#123;<br>            milliSleep(r.nextInt(<span class="hljs-number">1000</span>));<br>            System.out.printf(<span class="hljs-string">&quot;%s 离开！\n&quot;</span>, name);<br>            phaser.arriveAndAwaitAdvance();<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hug</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">if</span>(name.equals(<span class="hljs-string">&quot;新郎&quot;</span>) || name.equals(<span class="hljs-string">&quot;新娘&quot;</span>)) &#123;<br>                milliSleep(r.nextInt(<span class="hljs-number">1000</span>));<br>                System.out.printf(<span class="hljs-string">&quot;%s 洞房！\n&quot;</span>, name);<br>                phaser.arriveAndAwaitAdvance();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                phaser.arriveAndDeregister();<br>                <span class="hljs-comment">//phaser.register()</span><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>            arrive();<br>            eat();<br>            leave();<br>            hug();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="7-读写锁-ReadWriteLock"><a href="#7-读写锁-ReadWriteLock" class="headerlink" title="7. 读写锁 ReadWriteLock"></a>7. 读写锁 ReadWriteLock</h5><ul>
<li>共享锁</li>
<li>排他锁</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.LongAdder;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReadWriteLock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantReadWriteLock;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestReadWriteLock</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> value;<br><br>    <span class="hljs-keyword">static</span> ReadWriteLock readWriteLock = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();<br>    <span class="hljs-keyword">static</span> Lock readLock = readWriteLock.readLock();<br>    <span class="hljs-keyword">static</span> Lock writeLock = readWriteLock.writeLock();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">read</span><span class="hljs-params">(Lock lock)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            lock.lock();<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            System.out.println(<span class="hljs-string">&quot;read over!&quot;</span>);<br>            <span class="hljs-comment">//模拟读取操作</span><br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">write</span><span class="hljs-params">(Lock lock, <span class="hljs-keyword">int</span> v)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            lock.lock();<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            value = v;<br>            System.out.println(<span class="hljs-string">&quot;write over!&quot;</span>);<br>            <span class="hljs-comment">//模拟写操作</span><br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">//Runnable readR = ()-&gt; read(lock);</span><br>        Runnable readR = ()-&gt; read(readLock);<br><br>        <span class="hljs-comment">//Runnable writeR = ()-&gt;write(lock, new Random().nextInt());</span><br>        Runnable writeR = ()-&gt;write(writeLock, <span class="hljs-keyword">new</span> Random().nextInt());<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">18</span>; i++) <span class="hljs-keyword">new</span> Thread(readR).start();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">2</span>; i++) <span class="hljs-keyword">new</span> Thread(writeR).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="8-Semaphore-信号灯"><a href="#8-Semaphore-信号灯" class="headerlink" title="8. Semaphore 信号灯"></a>8. Semaphore 信号灯</h5><ul>
<li>限流 最多允许多少个线程运行</li>
<li>acquire()拿到值减1</li>
<li>release()放回1</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.Semaphore;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestSemaphore</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">//Semaphore s = new Semaphore(2);</span><br>        Semaphore s = <span class="hljs-keyword">new</span> Semaphore(<span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>);<br>        <span class="hljs-comment">//允许一个线程同时执行</span><br>        <span class="hljs-comment">//Semaphore s = new Semaphore(1);</span><br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                s.acquire();<br>                System.out.println(<span class="hljs-string">&quot;T1 running...&quot;</span>);<br>                Thread.sleep(<span class="hljs-number">200</span>);<br>                System.out.println(<span class="hljs-string">&quot;T1 running...&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                s.release();<br>            &#125;<br>        &#125;).start();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                s.acquire(); <span class="hljs-comment">//阻塞方法 得到，取得</span><br>                System.out.println(<span class="hljs-string">&quot;T2 running...&quot;</span>);<br>                Thread.sleep(<span class="hljs-number">200</span>);<br>                System.out.println(<span class="hljs-string">&quot;T2 running...&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                s.release();<br>            &#125;<br>        &#125;).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="9-Exchanger"><a href="#9-Exchanger" class="headerlink" title="9. Exchanger"></a>9. Exchanger</h5><p>exchange()方法阻塞 只会两个线程交换数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.Exchanger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestExchanger</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> Exchanger&lt;String&gt; exchanger = <span class="hljs-keyword">new</span> Exchanger&lt;&gt;();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            String s = <span class="hljs-string">&quot;T1&quot;</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                s = exchanger.exchange(s);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>       System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; &quot;</span> + s);<br><br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br>        <br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            String s = <span class="hljs-string">&quot;T2&quot;</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                s = exchanger.exchange(s);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; &quot;</span> + s);<br><br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="10-LockSupport"><a href="#10-LockSupport" class="headerlink" title="10. LockSupport"></a>10. LockSupport</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.LockSupport;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestLockSupport</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Thread t = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                System.out.println(i);<br>                <span class="hljs-keyword">if</span>(i == <span class="hljs-number">5</span>) &#123;<br>                    LockSupport.park(); <span class="hljs-comment">//停止线程 阻塞</span><br>                &#125;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;);<br><br>        t.start();<br><br>        LockSupport.unpark(t); <span class="hljs-comment">//解锁当前线程</span><br><br>        <span class="hljs-comment">/*try &#123;</span><br><span class="hljs-comment">            TimeUnit.SECONDS.sleep(8);</span><br><span class="hljs-comment">        &#125; catch (InterruptedException e) &#123;</span><br><span class="hljs-comment">            e.printStackTrace();</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">        System.out.println(&quot;after 8 senconds!&quot;);</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        LockSupport.unpark(t);*/</span><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="11-练习"><a href="#11-练习" class="headerlink" title="11.练习"></a>11.练习</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 曾经的面试题：（淘宝？）</span><br><span class="hljs-comment"> * 实现一个容器，提供两个方法，add，size</span><br><span class="hljs-comment"> * 写两个线程，线程1添加10个元素到容器中，线程2实现监控元素的个数，当个数到5个时，线程2给出提示并结束</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 分析下面这个程序，能完成这个功能吗？</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WithoutVolatile</span> </span>&#123;<br><br>	List lists = <span class="hljs-keyword">new</span> ArrayList();<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Object o)</span> </span>&#123;<br>		lists.add(o);<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> lists.size();<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		WithoutVolatile c = <span class="hljs-keyword">new</span> WithoutVolatile();<br><br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++) &#123;<br>				c.add(<span class="hljs-keyword">new</span> Object());<br>				System.out.println(<span class="hljs-string">&quot;add &quot;</span> + i);<br>				<br>				<span class="hljs-keyword">try</span> &#123;<br>					TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>				&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>					e.printStackTrace();<br>				&#125;<br>			&#125;<br>		&#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br>		<br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) &#123;<br>				<span class="hljs-keyword">if</span>(c.size() == <span class="hljs-number">5</span>) &#123;<br>					<span class="hljs-keyword">break</span>;<br>				&#125;<br>			&#125;<br>			System.out.println(<span class="hljs-string">&quot;t2 结束&quot;</span>);<br>		&#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 曾经的面试题：（淘宝？）</span><br><span class="hljs-comment"> * 实现一个容器，提供两个方法，add，size</span><br><span class="hljs-comment"> * 写两个线程，线程1添加10个元素到容器中，线程2实现监控元素的个数，当个数到5个时，线程2给出提示并结束</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 给lists添加volatile之后，t2能够接到通知，但是，t2线程的死循环很浪费cpu，如果不用死循环，</span><br><span class="hljs-comment"> * 而且，如果在if 和 break之间被别的线程打断，得到的结果也不精确，</span><br><span class="hljs-comment"> * 该怎么做呢？</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> java.util.Collections;<br><span class="hljs-keyword">import</span> java.util.LinkedList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WithVolatile</span> </span>&#123;<br><br>	<span class="hljs-comment">//添加volatile，使t2能够得到通知</span><br>	<span class="hljs-comment">//volatile List lists = new LinkedList();</span><br>	<span class="hljs-keyword">volatile</span> List lists = Collections.synchronizedList(<span class="hljs-keyword">new</span> LinkedList&lt;&gt;());<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Object o)</span> </span>&#123;<br>		lists.add(o);<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> lists.size();<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>		WithVolatile c = <span class="hljs-keyword">new</span> WithVolatile();<br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++) &#123;<br>				c.add(<span class="hljs-keyword">new</span> Object());<br>				System.out.println(<span class="hljs-string">&quot;add &quot;</span> + i);<br>				<br>				<span class="hljs-comment">/*try &#123;</span><br><span class="hljs-comment">					TimeUnit.SECONDS.sleep(1);</span><br><span class="hljs-comment">				&#125; catch (InterruptedException e) &#123;</span><br><span class="hljs-comment">					e.printStackTrace();</span><br><span class="hljs-comment">				&#125;*/</span><br>			&#125;<br>		&#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br>		<br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) &#123;<br>				<span class="hljs-keyword">if</span>(c.size() == <span class="hljs-number">5</span>) &#123;<br>					<span class="hljs-keyword">break</span>;<br>				&#125;<br>			&#125;<br>			System.out.println(<span class="hljs-string">&quot;t2 结束&quot;</span>);<br>		&#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 曾经的面试题：（淘宝？）</span><br><span class="hljs-comment"> * 实现一个容器，提供两个方法，add，size</span><br><span class="hljs-comment"> * 写两个线程，线程1添加10个元素到容器中，线程2实现监控元素的个数，当个数到5个时，线程2给出提示并结束</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 给lists添加volatile之后，t2能够接到通知，但是，t2线程的死循环很浪费cpu，如果不用死循环，该怎么做呢？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 这里使用wait和notify做到，wait会释放锁，而notify不会释放锁</span><br><span class="hljs-comment"> * 需要注意的是，运用这种方法，必须要保证t2先执行，也就是首先让t2监听才可以</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 阅读下面的程序，并分析输出结果</span><br><span class="hljs-comment"> * 可以读到输出结果并不是size=5时t2退出，而是t1结束时t2才接收到通知而退出</span><br><span class="hljs-comment"> * 想想这是为什么？</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotifyHoldingLock</span> </span>&#123; <span class="hljs-comment">//wait notify</span><br><br>	<span class="hljs-comment">//添加volatile，使t2能够得到通知</span><br>	<span class="hljs-keyword">volatile</span> List lists = <span class="hljs-keyword">new</span> ArrayList();<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Object o)</span> </span>&#123;<br>		lists.add(o);<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> lists.size();<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		NotifyHoldingLock c = <span class="hljs-keyword">new</span> NotifyHoldingLock();<br>		<br>		<span class="hljs-keyword">final</span> Object lock = <span class="hljs-keyword">new</span> Object();<br>		<br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			<span class="hljs-keyword">synchronized</span>(lock) &#123;<br>				System.out.println(<span class="hljs-string">&quot;t2启动&quot;</span>);<br>				<span class="hljs-keyword">if</span>(c.size() != <span class="hljs-number">5</span>) &#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						lock.wait();<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>				&#125;<br>				System.out.println(<span class="hljs-string">&quot;t2 结束&quot;</span>);<br>			&#125;<br>			<br>		&#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>		<br>		<span class="hljs-keyword">try</span> &#123;<br>			TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e1) &#123;<br>			e1.printStackTrace();<br>		&#125;<br><br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			System.out.println(<span class="hljs-string">&quot;t1启动&quot;</span>);<br>			<span class="hljs-keyword">synchronized</span>(lock) &#123;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++) &#123;<br>					c.add(<span class="hljs-keyword">new</span> Object());<br>					System.out.println(<span class="hljs-string">&quot;add &quot;</span> + i);<br>					<br>					<span class="hljs-keyword">if</span>(c.size() == <span class="hljs-number">5</span>) &#123;<br>						lock.notify();<br>					&#125;<br>					<br>					<span class="hljs-keyword">try</span> &#123;<br>						TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br>		<br>		<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 曾经的面试题：（淘宝？）</span><br><span class="hljs-comment"> * 实现一个容器，提供两个方法，add，size</span><br><span class="hljs-comment"> * 写两个线程，线程1添加10个元素到容器中，线程2实现监控元素的个数，当个数到5个时，线程2给出提示并结束</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 给lists添加volatile之后，t2能够接到通知，但是，t2线程的死循环很浪费cpu，如果不用死循环，该怎么做呢？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 这里使用wait和notify做到，wait会释放锁，而notify不会释放锁</span><br><span class="hljs-comment"> * 需要注意的是，运用这种方法，必须要保证t2先执行，也就是首先让t2监听才可以</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 阅读下面的程序，并分析输出结果</span><br><span class="hljs-comment"> * 可以读到输出结果并不是size=5时t2退出，而是t1结束时t2才接收到通知而退出</span><br><span class="hljs-comment"> * 想想这是为什么？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * notify之后，t1必须释放锁，t2退出后，也必须notify，通知t1继续执行</span><br><span class="hljs-comment"> * 整个通信过程比较繁琐</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotifyFreeLock</span> </span>&#123;<br><br>	<span class="hljs-comment">//添加volatile，使t2能够得到通知</span><br>	<span class="hljs-keyword">volatile</span> List lists = <span class="hljs-keyword">new</span> ArrayList();<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Object o)</span> </span>&#123;<br>		lists.add(o);<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> lists.size();<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		NotifyFreeLock c = <span class="hljs-keyword">new</span> NotifyFreeLock();<br>		<br>		<span class="hljs-keyword">final</span> Object lock = <span class="hljs-keyword">new</span> Object();<br>		<br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			<span class="hljs-keyword">synchronized</span>(lock) &#123;<br>				System.out.println(<span class="hljs-string">&quot;t2启动&quot;</span>);<br>				<span class="hljs-keyword">if</span>(c.size() != <span class="hljs-number">5</span>) &#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						lock.wait();<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>				&#125;<br>				System.out.println(<span class="hljs-string">&quot;t2 结束&quot;</span>);<br>				<span class="hljs-comment">//通知t1继续执行</span><br>				lock.notify();<br>			&#125;<br>			<br>		&#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>		<br>		<span class="hljs-keyword">try</span> &#123;<br>			TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e1) &#123;<br>			e1.printStackTrace();<br>		&#125;<br><br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			System.out.println(<span class="hljs-string">&quot;t1启动&quot;</span>);<br>			<span class="hljs-keyword">synchronized</span>(lock) &#123;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++) &#123;<br>					c.add(<span class="hljs-keyword">new</span> Object());<br>					System.out.println(<span class="hljs-string">&quot;add &quot;</span> + i);<br>					<br>					<span class="hljs-keyword">if</span>(c.size() == <span class="hljs-number">5</span>) &#123;<br>						lock.notify();<br>						<span class="hljs-comment">//释放锁，让t2得以执行</span><br>						<span class="hljs-keyword">try</span> &#123;<br>							lock.wait();<br>						&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>							e.printStackTrace();<br>						&#125;<br>					&#125;<br>					<br>					<span class="hljs-keyword">try</span> &#123;<br>						TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 曾经的面试题：（淘宝？）</span><br><span class="hljs-comment"> * 实现一个容器，提供两个方法，add，size</span><br><span class="hljs-comment"> * 写两个线程，线程1添加10个元素到容器中，线程2实现监控元素的个数，当个数到5个时，线程2给出提示并结束</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 给lists添加volatile之后，t2能够接到通知，但是，t2线程的死循环很浪费cpu，如果不用死循环，该怎么做呢？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 这里使用wait和notify做到，wait会释放锁，而notify不会释放锁</span><br><span class="hljs-comment"> * 需要注意的是，运用这种方法，必须要保证t2先执行，也就是首先让t2监听才可以</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 阅读下面的程序，并分析输出结果</span><br><span class="hljs-comment"> * 可以读到输出结果并不是size=5时t2退出，而是t1结束时t2才接收到通知而退出</span><br><span class="hljs-comment"> * 想想这是为什么？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * notify之后，t1必须释放锁，t2退出后，也必须notify，通知t1继续执行</span><br><span class="hljs-comment"> * 整个通信过程比较繁琐</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用Latch（门闩）替代wait notify来进行通知</span><br><span class="hljs-comment"> * 好处是通信方式简单，同时也可以指定等待时间</span><br><span class="hljs-comment"> * 使用await和countdown方法替代wait和notify</span><br><span class="hljs-comment"> * CountDownLatch不涉及锁定，当count的值为零时当前线程继续运行</span><br><span class="hljs-comment"> * 当不涉及同步，只是涉及线程通信的时候，用synchronized + wait/notify就显得太重了</span><br><span class="hljs-comment"> * 这时应该考虑countdownlatch/cyclicbarrier/semaphore</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountDownLatch</span> </span>&#123;<br><br>	<span class="hljs-comment">// 添加volatile，使t2能够得到通知</span><br>	<span class="hljs-keyword">volatile</span> List lists = <span class="hljs-keyword">new</span> ArrayList();<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Object o)</span> </span>&#123;<br>		lists.add(o);<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> lists.size();<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		T05_CountDownLatch c = <span class="hljs-keyword">new</span> CountDownLatch();<br><br>		CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);<br><br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			System.out.println(<span class="hljs-string">&quot;t2启动&quot;</span>);<br>			<span class="hljs-keyword">if</span> (c.size() != <span class="hljs-number">5</span>) &#123;<br>				<span class="hljs-keyword">try</span> &#123;<br>					latch.await();<br>					<br>					<span class="hljs-comment">//也可以指定等待时间</span><br>					<span class="hljs-comment">//latch.await(5000, TimeUnit.MILLISECONDS);</span><br>				&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>					e.printStackTrace();<br>				&#125;<br>			&#125;<br>			System.out.println(<span class="hljs-string">&quot;t2 结束&quot;</span>);<br><br>		&#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br><br>		<span class="hljs-keyword">try</span> &#123;<br>			TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e1) &#123;<br>			e1.printStackTrace();<br>		&#125;<br><br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			System.out.println(<span class="hljs-string">&quot;t1启动&quot;</span>);<br>			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>				c.add(<span class="hljs-keyword">new</span> Object());<br>				System.out.println(<span class="hljs-string">&quot;add &quot;</span> + i);<br><br>				<span class="hljs-keyword">if</span> (c.size() == <span class="hljs-number">5</span>) &#123;<br>					<span class="hljs-comment">// 打开门闩，让t2得以执行</span><br>					latch.countDown();<br>				&#125;<br><br>				<span class="hljs-comment">/*try &#123;</span><br><span class="hljs-comment">					TimeUnit.SECONDS.sleep(1);</span><br><span class="hljs-comment">				&#125; catch (InterruptedException e) &#123;</span><br><span class="hljs-comment">					e.printStackTrace();</span><br><span class="hljs-comment">				&#125;*/</span><br>			&#125;<br><br>		&#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 曾经的面试题：（淘宝？）</span><br><span class="hljs-comment"> * 实现一个容器，提供两个方法，add，size</span><br><span class="hljs-comment"> * 写两个线程，线程1添加10个元素到容器中，线程2实现监控元素的个数，当个数到5个时，线程2给出提示并结束</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 给lists添加volatile之后，t2能够接到通知，但是，t2线程的死循环很浪费cpu，如果不用死循环，该怎么做呢？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 这里使用wait和notify做到，wait会释放锁，而notify不会释放锁</span><br><span class="hljs-comment"> * 需要注意的是，运用这种方法，必须要保证t2先执行，也就是首先让t2监听才可以</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 阅读下面的程序，并分析输出结果</span><br><span class="hljs-comment"> * 可以读到输出结果并不是size=5时t2退出，而是t1结束时t2才接收到通知而退出</span><br><span class="hljs-comment"> * 想想这是为什么？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * notify之后，t1必须释放锁，t2退出后，也必须notify，通知t1继续执行</span><br><span class="hljs-comment"> * 整个通信过程比较繁琐</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用Latch（门闩）替代wait notify来进行通知</span><br><span class="hljs-comment"> * 好处是通信方式简单，同时也可以指定等待时间</span><br><span class="hljs-comment"> * 使用await和countdown方法替代wait和notify</span><br><span class="hljs-comment"> * CountDownLatch不涉及锁定，当count的值为零时当前线程继续运行</span><br><span class="hljs-comment"> * 当不涉及同步，只是涉及线程通信的时候，用synchronized + wait/notify就显得太重了</span><br><span class="hljs-comment"> * 这时应该考虑countdownlatch/cyclicbarrier/semaphore</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.LockSupport;<br><br><span class="hljs-comment">//TODO park unpark</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LockSupport</span> </span>&#123;<br><br>	<span class="hljs-comment">// 添加volatile，使t2能够得到通知</span><br>	<span class="hljs-keyword">volatile</span> List lists = <span class="hljs-keyword">new</span> ArrayList();<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Object o)</span> </span>&#123;<br>		lists.add(o);<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> lists.size();<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		LockSupport c = <span class="hljs-keyword">new</span> LockSupport();<br><br>		CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);<br><br>		Thread t2 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			System.out.println(<span class="hljs-string">&quot;t2启动&quot;</span>);<br>			<span class="hljs-keyword">if</span> (c.size() != <span class="hljs-number">5</span>) &#123;<br><br>				LockSupport.park();<br><br>			&#125;<br>			System.out.println(<span class="hljs-string">&quot;t2 结束&quot;</span>);<br><br><br>		&#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br><br>		t2.start();<br><br>		<span class="hljs-keyword">try</span> &#123;<br>			TimeUnit.SECONDS.sleep(<span class="hljs-number">1</span>);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e1) &#123;<br>			e1.printStackTrace();<br>		&#125;<br><br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			System.out.println(<span class="hljs-string">&quot;t1启动&quot;</span>);<br>			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>				c.add(<span class="hljs-keyword">new</span> Object());<br>				System.out.println(<span class="hljs-string">&quot;add &quot;</span> + i);<br><br>				<span class="hljs-keyword">if</span> (c.size() == <span class="hljs-number">5</span>) &#123;<br>					LockSupport.unpark(t2);<br>				&#125;<br><br>				<span class="hljs-comment">/*try &#123;</span><br><span class="hljs-comment">					TimeUnit.SECONDS.sleep(1);</span><br><span class="hljs-comment">				&#125; catch (InterruptedException e) &#123;</span><br><span class="hljs-comment">					e.printStackTrace();</span><br><span class="hljs-comment">				&#125;*/</span><br>			&#125;<br><br>		&#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 曾经的面试题：（淘宝？）</span><br><span class="hljs-comment"> * 实现一个容器，提供两个方法，add，size</span><br><span class="hljs-comment"> * 写两个线程，线程1添加10个元素到容器中，线程2实现监控元素的个数，当个数到5个时，线程2给出提示并结束</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 给lists添加volatile之后，t2能够接到通知，但是，t2线程的死循环很浪费cpu，如果不用死循环，该怎么做呢？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 这里使用wait和notify做到，wait会释放锁，而notify不会释放锁</span><br><span class="hljs-comment"> * 需要注意的是，运用这种方法，必须要保证t2先执行，也就是首先让t2监听才可以</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 阅读下面的程序，并分析输出结果</span><br><span class="hljs-comment"> * 可以读到输出结果并不是size=5时t2退出，而是t1结束时t2才接收到通知而退出</span><br><span class="hljs-comment"> * 想想这是为什么？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * notify之后，t1必须释放锁，t2退出后，也必须notify，通知t1继续执行</span><br><span class="hljs-comment"> * 整个通信过程比较繁琐</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用Latch（门闩）替代wait notify来进行通知</span><br><span class="hljs-comment"> * 好处是通信方式简单，同时也可以指定等待时间</span><br><span class="hljs-comment"> * 使用await和countdown方法替代wait和notify</span><br><span class="hljs-comment"> * CountDownLatch不涉及锁定，当count的值为零时当前线程继续运行</span><br><span class="hljs-comment"> * 当不涉及同步，只是涉及线程通信的时候，用synchronized + wait/notify就显得太重了</span><br><span class="hljs-comment"> * 这时应该考虑countdownlatch/cyclicbarrier/semaphore</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> mashibing</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.LockSupport;<br><br><span class="hljs-comment">//TODO park unpark</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LockSupport_WithoutSleep</span> </span>&#123;<br><br>	<span class="hljs-comment">// 添加volatile，使t2能够得到通知</span><br>	<span class="hljs-keyword">volatile</span> List lists = <span class="hljs-keyword">new</span> ArrayList();<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Object o)</span> </span>&#123;<br>		lists.add(o);<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> lists.size();<br>	&#125;<br><br>	<span class="hljs-keyword">static</span> Thread t1 = <span class="hljs-keyword">null</span>, t2 = <span class="hljs-keyword">null</span>;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		LockSupport_WithoutSleep c = <span class="hljs-keyword">new</span> LockSupport_WithoutSleep();<br><br>		t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			System.out.println(<span class="hljs-string">&quot;t1启动&quot;</span>);<br>			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>				c.add(<span class="hljs-keyword">new</span> Object());<br>				System.out.println(<span class="hljs-string">&quot;add &quot;</span> + i);<br><br>				<span class="hljs-keyword">if</span> (c.size() == <span class="hljs-number">5</span>) &#123;<br>					LockSupport.unpark(t2);<br>					LockSupport.park();<br>				&#125;<br>			&#125;<br>		&#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>		t2 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			<span class="hljs-comment">//System.out.println(&quot;t2启动&quot;);</span><br>			<span class="hljs-comment">//if (c.size() != 5) &#123;</span><br><br>				LockSupport.park();<br><br>			<span class="hljs-comment">//&#125;</span><br>			System.out.println(<span class="hljs-string">&quot;t2 结束&quot;</span>);<br>			LockSupport.unpark(t1);<br><br><br>		&#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br><br>		t2.start();<br>		t1.start();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.Semaphore;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.LockSupport;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Semaphore</span> </span>&#123;<br>    <span class="hljs-comment">// 添加volatile，使t2能够得到通知</span><br>    <span class="hljs-keyword">volatile</span> List lists = <span class="hljs-keyword">new</span> ArrayList();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Object o)</span> </span>&#123;<br>        lists.add(o);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> lists.size();<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> Thread t1 = <span class="hljs-keyword">null</span>, t2 = <span class="hljs-keyword">null</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Semaphore c = <span class="hljs-keyword">new</span> Semaphore();<br>        Semaphore s = <span class="hljs-keyword">new</span> Semaphore(<span class="hljs-number">1</span>);<br><br>        t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                s.acquire();<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>                    c.add(<span class="hljs-keyword">new</span> Object());<br>                    System.out.println(<span class="hljs-string">&quot;add &quot;</span> + i);<br><br><br>                &#125;<br>                s.release();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                t2.start();<br>                t2.join();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                s.acquire();<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">5</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>                    System.out.println(i);<br>                &#125;<br>                s.release();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br><br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>        t2 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                s.acquire();<br>                System.out.println(<span class="hljs-string">&quot;t2 结束&quot;</span>);<br>                s.release();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br><br>        <span class="hljs-comment">//t2.start();</span><br>        t1.start();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 面试题：写一个固定容量同步容器，拥有put和get方法，以及getCount方法，</span><br><span class="hljs-comment"> * 能够支持2个生产者线程以及10个消费者线程的阻塞调用</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用wait和notify/notifyAll来实现</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> java.util.LinkedList;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyContainer1</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br>	<span class="hljs-keyword">final</span> <span class="hljs-keyword">private</span> LinkedList&lt;T&gt; lists = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();<br>	<span class="hljs-keyword">final</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> MAX = <span class="hljs-number">10</span>; <span class="hljs-comment">//最多10个元素</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br>	<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(T t)</span> </span>&#123;<br>		<span class="hljs-keyword">while</span>(lists.size() == MAX) &#123; <span class="hljs-comment">//想想为什么用while而不是用if？</span><br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-keyword">this</span>.wait(); <span class="hljs-comment">//effective java</span><br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				e.printStackTrace();<br>			&#125;<br>		&#125;<br>		<br>		lists.add(t);<br>		++count;<br>		<span class="hljs-keyword">this</span>.notifyAll(); <span class="hljs-comment">//通知消费者线程进行消费</span><br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> T <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>		T t = <span class="hljs-keyword">null</span>;<br>		<span class="hljs-keyword">while</span>(lists.size() == <span class="hljs-number">0</span>) &#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-keyword">this</span>.wait();<br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				e.printStackTrace();<br>			&#125;<br>		&#125;<br>		t = lists.removeFirst();<br>		count --;<br>		<span class="hljs-keyword">this</span>.notifyAll(); <span class="hljs-comment">//通知生产者进行生产</span><br>		<span class="hljs-keyword">return</span> t;<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		MyContainer1&lt;String&gt; c = <span class="hljs-keyword">new</span> MyContainer1&lt;&gt;();<br>		<span class="hljs-comment">//启动消费者线程</span><br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++) &#123;<br>			<span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">5</span>; j++) System.out.println(c.get());<br>			&#125;, <span class="hljs-string">&quot;c&quot;</span> + i).start();<br>		&#125;<br>		<br>		<span class="hljs-keyword">try</span> &#123;<br>			TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>		<br>		<span class="hljs-comment">//启动生产者线程</span><br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">2</span>; i++) &#123;<br>			<span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">25</span>; j++) c.put(Thread.currentThread().getName() + <span class="hljs-string">&quot; &quot;</span> + j);<br>			&#125;, <span class="hljs-string">&quot;p&quot;</span> + i).start();<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 面试题：写一个固定容量同步容器，拥有put和get方法，以及getCount方法，</span><br><span class="hljs-comment"> * 能够支持2个生产者线程以及10个消费者线程的阻塞调用</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用wait和notify/notifyAll来实现</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用Lock和Condition来实现</span><br><span class="hljs-comment"> * 对比两种方式，Condition的方式可以更加精确的指定哪些线程被唤醒</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> java.util.LinkedList;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyContainer2</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br>	<span class="hljs-keyword">final</span> <span class="hljs-keyword">private</span> LinkedList&lt;T&gt; lists = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();<br>	<span class="hljs-keyword">final</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> MAX = <span class="hljs-number">10</span>; <span class="hljs-comment">//最多10个元素</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br>	<br>	<span class="hljs-keyword">private</span> Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>	<span class="hljs-keyword">private</span> Condition producer = lock.newCondition();<br>	<span class="hljs-keyword">private</span> Condition consumer = lock.newCondition();<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(T t)</span> </span>&#123;<br>		<span class="hljs-keyword">try</span> &#123;<br>			lock.lock();<br>			<span class="hljs-keyword">while</span>(lists.size() == MAX) &#123; <span class="hljs-comment">//想想为什么用while而不是用if？</span><br>				producer.await();<br>			&#125;<br>			<br>			lists.add(t);<br>			++count;<br>			consumer.signalAll(); <span class="hljs-comment">//通知消费者线程进行消费</span><br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">finally</span> &#123;<br>			lock.unlock();<br>		&#125;<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>		T t = <span class="hljs-keyword">null</span>;<br>		<span class="hljs-keyword">try</span> &#123;<br>			lock.lock();<br>			<span class="hljs-keyword">while</span>(lists.size() == <span class="hljs-number">0</span>) &#123;<br>				consumer.await();<br>			&#125;<br>			t = lists.removeFirst();<br>			count --;<br>			producer.signalAll(); <span class="hljs-comment">//通知生产者进行生产</span><br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">finally</span> &#123;<br>			lock.unlock();<br>		&#125;<br>		<span class="hljs-keyword">return</span> t;<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		MyContainer2&lt;String&gt; c = <span class="hljs-keyword">new</span> MyContainer2&lt;&gt;();<br>		<span class="hljs-comment">//启动消费者线程</span><br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++) &#123;<br>			<span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">5</span>; j++) System.out.println(c.get());<br>			&#125;, <span class="hljs-string">&quot;c&quot;</span> + i).start();<br>		&#125;<br>		<br>		<span class="hljs-keyword">try</span> &#123;<br>			TimeUnit.SECONDS.sleep(<span class="hljs-number">2</span>);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>		<br>		<span class="hljs-comment">//启动生产者线程</span><br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">2</span>; i++) &#123;<br>			<span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">25</span>; j++) c.put(Thread.currentThread().getName() + <span class="hljs-string">&quot; &quot;</span> + j);<br>			&#125;, <span class="hljs-string">&quot;p&quot;</span> + i).start();<br>		&#125;<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2021/04/06/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/04-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/">← Prev 04-多线程与高并发</a><span style="color: #fe2"> | </span><a href="/2021/04/03/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/02-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/">02-多线程与高并发 Next →</a><hr></div><div id="bottom-btn"><a id="to-top" href="#post-title" title="to top">∧</a></div><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: ''
 , appKey: ''
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://scpic.chinaz.net/files/pic/pic9/202104/apic31860.jpg" alt="Logo"></a><h1 id="Dr"><a href="/"> Dr.浅陌</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">14</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">3</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">3</span></div></section></div><div id="aside-block" style="order: -1"></div><footer style="text-align: right"><wbr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>