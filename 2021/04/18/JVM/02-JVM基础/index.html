<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>02-JVM基础 | Hexo</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a></nav></header><main style="flex-direction: row-reverse"><article><div id="post-bg"><div id="post-title"><h1>02-JVM基础</h1><hr></div><div id="post-content"><h5 id="一、Class-Loading-Linking-Initlizing"><a href="#一、Class-Loading-Linking-Initlizing" class="headerlink" title="一、Class Loading Linking Initlizing"></a>一、Class Loading Linking Initlizing</h5><p><img src="https://note.youdao.com/yws/public/resource/440b71dabe81b5ef9cc60f5976a645a6/xmlnote/DB33376EAE424452BC0206C3F90CD356/21" alt="class cycle"></p>
<h5 id="二、ClassLorder-类加载器"><a href="#二、ClassLorder-类加载器" class="headerlink" title="二、ClassLorder 类加载器"></a>二、ClassLorder 类加载器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//获取具体哪个ClassLoader 类 </span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassLoaderLevel</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        System.out.println(String.class.getClassLoader());	<span class="hljs-comment">//null 被Bootstrap加载</span><br>        System.out.println(sun.awt.HKSCS.class.getClassLoader());   <span class="hljs-comment">//null 被Bootstrap加载</span><br>   System.out.println(sun.net.spi.nameservice.dns.DNSNameService.class.getClassLoader());<br>        <span class="hljs-comment">//被 sun.misc.Launcher$ExtClassLoader 加载</span><br>        System.out.println(T002_ClassLoaderLevel.class.getClassLoader()); <span class="hljs-comment">//被sun.misc.Launcher$AppClassLoader 加载</span><br>     System.out.println(sun.net.spi.nameservice.dns.DNSNameService.class.getClassLoader().getClass().getClassLoader());<br>        System.out.println(T002_ClassLoaderLevel.class.getClassLoader().getClass().getClassLoader());<br><br>        System.out.println(<span class="hljs-keyword">new</span> T006_MSBClassLoader().getParent());<br>        System.out.println(ClassLoader.getSystemClassLoader());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="https://note.youdao.com/yws/public/resource/440b71dabe81b5ef9cc60f5976a645a6/xmlnote/775348C9E18C4B4EAE04AC1F818E686B/18" alt="类加载器"></p>
<h5 id="三、双亲委派"><a href="#三、双亲委派" class="headerlink" title="三、双亲委派"></a>三、双亲委派</h5><ul>
<li>父加载器不是类加载器的加载器，也不是类加载器的父类加载器</li>
<li>双亲委派是一个孩子向父亲方向，然后父亲向孩子方向的双亲委派过程</li>
<li>为什么要搞双亲委派<ul>
<li>java.lang.String类由自定义类加载器加载行不行         不行 为了安全才搞双亲委派</li>
</ul>
</li>
</ul>
<p><img src="https://note.youdao.com/yws/public/resource/440b71dabe81b5ef9cc60f5976a645a6/xmlnote/8B0AA783DCCD4E5DB212AFCEBFA15F2E/17" alt="类加载过程"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParentAndChild</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        System.out.println(ParentAndChild.class.getClassLoader()); <span class="hljs-comment">//APP</span><br>        System.out.println(ParentAndChild.class.getClassLoader().getClass().getClassLoader()); <span class="hljs-comment">// null</span><br>        System.out.println(ParentAndChild.class.getClassLoader().getParent()); <span class="hljs-comment">//ext</span><br>        System.out.println(ParentAndChild.class.getClassLoader().getParent().getParent()); <span class="hljs-comment">//null</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="四、父加载器的范围"><a href="#四、父加载器的范围" class="headerlink" title="四、父加载器的范围"></a>四、父加载器的范围</h5><ul>
<li>Launcher源码<ul>
<li>sun.boot.class.path<ul>
<li>Bootstrap ClassLoader加载路径</li>
</ul>
</li>
<li>java.ext.dirs<ul>
<li>ExtensionClassLoader加载路径</li>
</ul>
</li>
<li>java.class.path<ul>
<li>AppClassLoader加载路径</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassLoaderScope</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String pathBoot = System.getProperty(<span class="hljs-string">&quot;sun.boot.class.path&quot;</span>);<br>        System.out.println(pathBoot.replaceAll(<span class="hljs-string">&quot;;&quot;</span>, System.lineSeparator()));<br><br>        System.out.println(<span class="hljs-string">&quot;--------------------&quot;</span>);<br>        String pathExt = System.getProperty(<span class="hljs-string">&quot;java.ext.dirs&quot;</span>);<br>        System.out.println(pathExt.replaceAll(<span class="hljs-string">&quot;;&quot;</span>, System.lineSeparator()));<br><br>        System.out.println(<span class="hljs-string">&quot;--------------------&quot;</span>);<br>        String pathApp = System.getProperty(<span class="hljs-string">&quot;java.class.path&quot;</span>);<br>        System.out.println(pathApp.replaceAll(<span class="hljs-string">&quot;;&quot;</span>, System.lineSeparator()));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="五、自定义类加载器（模板设计模式）"><a href="#五、自定义类加载器（模板设计模式）" class="headerlink" title="五、自定义类加载器（模板设计模式）"></a>五、自定义类加载器（模板设计模式）</h5><ul>
<li>继承ClassLoader</li>
<li>重写模板方法findClass<ul>
<li>调用defineClass</li>
</ul>
</li>
<li>自定义类加载器加载自加密的class<ul>
<li>防止反编译</li>
<li>防止篡改</li>
</ul>
</li>
</ul>
<p>加载指定路径</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.mashibing.jvm.Hello;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MSBClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ClassLoader</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        File f = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;c:/test/&quot;</span>, name.replace(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>).concat(<span class="hljs-string">&quot;.class&quot;</span>));<br>        <span class="hljs-keyword">try</span> &#123;<br>            FileInputStream fis = <span class="hljs-keyword">new</span> FileInputStream(f);<br>            ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>            <span class="hljs-keyword">int</span> b = <span class="hljs-number">0</span>;<br><br>            <span class="hljs-keyword">while</span> ((b=fis.read()) !=<span class="hljs-number">0</span>) &#123;<br>                baos.write(b);<br>            &#125;<br><br>            <span class="hljs-keyword">byte</span>[] bytes = baos.toByteArray();<br>            baos.close();<br>            fis.close();<span class="hljs-comment">//可以写的更加严谨</span><br><br>            <span class="hljs-keyword">return</span> defineClass(name, bytes, <span class="hljs-number">0</span>, bytes.length);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.findClass(name); <span class="hljs-comment">//throws ClassNotFoundException</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassLoader l = <span class="hljs-keyword">new</span> MSBClassLoader();<br>        Class clazz = l.loadClass(<span class="hljs-string">&quot;com.mashibing.jvm.Hello&quot;</span>);<br>        Class clazz1 = l.loadClass(<span class="hljs-string">&quot;com.mashibing.jvm.Hello&quot;</span>);<br><br>        System.out.println(clazz == clazz1);<br><br>        Hello h = (Hello)clazz.newInstance();<br>        h.m();<br><br>        System.out.println(l.getClass().getClassLoader());<br>        System.out.println(l.getParent());<br><br>        System.out.println(getSystemClassLoader());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoadClassByHand</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException </span>&#123;<br>        Class clazz = LoadClassByHand.class.getClassLoader().loadClass(<span class="hljs-string">&quot;com.mashibing.jvm.classloader.ClassLoaderLevel&quot;</span>);<br>        System.out.println(clazz.getName());<br><br>        <span class="hljs-comment">//利用类加载器加载资源，参考坦克图片的加载</span><br>        <span class="hljs-comment">//LoadClassByHand.class.getClassLoader().getResourceAsStream(&quot;&quot;);</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<ul>
<li>loadClass 源码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Loads the class with the specified &lt;a href=&quot;#name&quot;&gt;binary name&lt;/a&gt;.  The</span><br><span class="hljs-comment">    * default implementation of this method searches for classes in the</span><br><span class="hljs-comment">    * following order:</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * &lt;ol&gt;</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    *   &lt;li&gt;&lt;p&gt; Invoke &#123;<span class="hljs-doctag">@link</span> #findLoadedClass(String)&#125; to check if the class</span><br><span class="hljs-comment">    *   has already been loaded.  &lt;/p&gt;&lt;/li&gt;</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    *   &lt;li&gt;&lt;p&gt; Invoke the &#123;<span class="hljs-doctag">@link</span> #loadClass(String) &lt;tt&gt;loadClass&lt;/tt&gt;&#125; method</span><br><span class="hljs-comment">    *   on the parent class loader.  If the parent is &lt;tt&gt;null&lt;/tt&gt; the class</span><br><span class="hljs-comment">    *   loader built-in to the virtual machine is used, instead.  &lt;/p&gt;&lt;/li&gt;</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    *   &lt;li&gt;&lt;p&gt; Invoke the &#123;<span class="hljs-doctag">@link</span> #findClass(String)&#125; method to find the</span><br><span class="hljs-comment">    *   class.  &lt;/p&gt;&lt;/li&gt;</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * &lt;/ol&gt;</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * &lt;p&gt; If the class was found using the above steps, and the</span><br><span class="hljs-comment">    * &lt;tt&gt;resolve&lt;/tt&gt; flag is true, this method will then invoke the &#123;<span class="hljs-doctag">@link</span></span><br><span class="hljs-comment">    * #resolveClass(Class)&#125; method on the resulting &lt;tt&gt;Class&lt;/tt&gt; object.</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * &lt;p&gt; Subclasses of &lt;tt&gt;ClassLoader&lt;/tt&gt; are encouraged to override &#123;<span class="hljs-doctag">@link</span></span><br><span class="hljs-comment">    * #findClass(String)&#125;, rather than this method.  &lt;/p&gt;</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * &lt;p&gt; Unless overridden, this method synchronizes on the result of</span><br><span class="hljs-comment">    * &#123;<span class="hljs-doctag">@link</span> #getClassLoadingLock &lt;tt&gt;getClassLoadingLock&lt;/tt&gt;&#125; method</span><br><span class="hljs-comment">    * during the entire class loading process.</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span>  name</span><br><span class="hljs-comment">    *         The &lt;a href=&quot;#name&quot;&gt;binary name&lt;/a&gt; of the class</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span>  resolve</span><br><span class="hljs-comment">    *         If &lt;tt&gt;true&lt;/tt&gt; then resolve the class</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span>  The resulting &lt;tt&gt;Class&lt;/tt&gt; object</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@throws</span>  ClassNotFoundException</span><br><span class="hljs-comment">    *          If the class could not be found</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-keyword">boolean</span> resolve)<br>       <span class="hljs-keyword">throws</span> ClassNotFoundException<br>   &#123;<br>       <span class="hljs-keyword">synchronized</span> (getClassLoadingLock(name)) &#123;<br>           <span class="hljs-comment">// First, check if the class has already been loaded</span><br>           Class&lt;?&gt; c = findLoadedClass(name);<br>           <span class="hljs-keyword">if</span> (c == <span class="hljs-keyword">null</span>) &#123;<br>               <span class="hljs-keyword">long</span> t0 = System.nanoTime();<br>               <span class="hljs-keyword">try</span> &#123;<br>                   <span class="hljs-keyword">if</span> (parent != <span class="hljs-keyword">null</span>) &#123;<br>                       c = parent.loadClass(name, <span class="hljs-keyword">false</span>);<br>                   &#125; <span class="hljs-keyword">else</span> &#123;<br>                       c = findBootstrapClassOrNull(name);<br>                   &#125;<br>               &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>                   <span class="hljs-comment">// ClassNotFoundException thrown if class not found</span><br>                   <span class="hljs-comment">// from the non-null parent class loader</span><br>               &#125;<br><br>               <span class="hljs-keyword">if</span> (c == <span class="hljs-keyword">null</span>) &#123;<br>                   <span class="hljs-comment">// If still not found, then invoke findClass in order</span><br>                   <span class="hljs-comment">// to find the class.</span><br>                   <span class="hljs-keyword">long</span> t1 = System.nanoTime();<br>                   c = findClass(name);<br><br>                   <span class="hljs-comment">// this is the defining class loader; record the stats</span><br>                   sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);<br>                   sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);<br>                   sun.misc.PerfCounter.getFindClasses().increment();<br>               &#125;<br>           &#125;<br>           <span class="hljs-keyword">if</span> (resolve) &#123;<br>               resolveClass(c);<br>           &#125;<br>           <span class="hljs-keyword">return</span> c;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<h5 id="六、加密"><a href="#六、加密" class="headerlink" title="六、加密"></a>六、加密</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.mashibing.jvm.Hello;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MSBClassLoaderWithEncription</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ClassLoader</span> </span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> seed = <span class="hljs-number">0B10110110</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        File f = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;c:/test/&quot;</span>, name.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>).concat(<span class="hljs-string">&quot;.msbclass&quot;</span>));<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            FileInputStream fis = <span class="hljs-keyword">new</span> FileInputStream(f);<br>            ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>            <span class="hljs-keyword">int</span> b = <span class="hljs-number">0</span>;<br><br>            <span class="hljs-keyword">while</span> ((b=fis.read()) !=<span class="hljs-number">0</span>) &#123;<br>                baos.write(b ^ seed);<br>            &#125;<br><br>            <span class="hljs-keyword">byte</span>[] bytes = baos.toByteArray();<br>            baos.close();<br>            fis.close();<span class="hljs-comment">//可以写的更加严谨</span><br><br>            <span class="hljs-keyword">return</span> defineClass(name, bytes, <span class="hljs-number">0</span>, bytes.length);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.findClass(name); <span class="hljs-comment">//throws ClassNotFoundException</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>        encFile(<span class="hljs-string">&quot;com.mashibing.jvm.hello&quot;</span>);<br><br>        ClassLoader l = <span class="hljs-keyword">new</span> MSBClassLoaderWithEncription();<br>        Class clazz = l.loadClass(<span class="hljs-string">&quot;com.mashibing.jvm.Hello&quot;</span>);<br>        Hello h = (Hello)clazz.newInstance();<br>        h.m();<br><br>        System.out.println(l.getClass().getClassLoader());<br>        System.out.println(l.getParent());<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">encFile</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        File f = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;c:/test/&quot;</span>, name.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>).concat(<span class="hljs-string">&quot;.class&quot;</span>));<br>        FileInputStream fis = <span class="hljs-keyword">new</span> FileInputStream(f);<br>        FileOutputStream fos = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;c:/test/&quot;</span>, name.replaceAll(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>).concat(<span class="hljs-string">&quot;.msbclass&quot;</span>)));<br>        <span class="hljs-keyword">int</span> b = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">while</span>((b = fis.read()) != -<span class="hljs-number">1</span>) &#123;<br>            fos.write(b ^ seed);<br>        &#125;<br><br>        fis.close();<br>        fos.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="七、编译器"><a href="#七、编译器" class="headerlink" title="七、编译器"></a>七、编译器</h5><ul>
<li>解释器<ul>
<li>bytecode intepreter</li>
</ul>
</li>
<li>JIT<ul>
<li>Just In-Time compiler</li>
</ul>
</li>
<li>混合模式<ul>
<li>混合使用解释器 + 热点代码编译</li>
<li>其实阶段采用解释执行</li>
<li>热点代码检测<ul>
<li>多次被调用的方法（方法计数器：监测方法执行频率）</li>
<li>多次被调用的循环（循环计数器：检测循环执行频率）</li>
<li>进行编译</li>
</ul>
</li>
</ul>
</li>
<li>-Xmixed 默认为混合模式，开始解释执行，启动速度较快对热点代码进行检测和编译</li>
<li>-Xint 使用解释模式，启动很快，执行稍慢</li>
<li>-Xcomp 使用纯编译模式，执行很快，启动很慢</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WayToRun</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10_0000</span>; i++)<br>            m();<br><br>        <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10_0000</span>; i++) &#123;<br>            m();<br>        &#125;<br>        <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>        System.out.println(end - start);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">m</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">long</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10_0000L</span>; i++) &#123;<br>            <span class="hljs-keyword">long</span> j = i%<span class="hljs-number">3</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="八、lazyloading"><a href="#八、lazyloading" class="headerlink" title="八、lazyloading"></a>八、lazyloading</h5><ul>
<li>严格讲应该叫lazyInitializing</li>
<li>JVM规范并没有规定何时加载</li>
<li>但是严格规定了什么时候必须初始化<ul>
<li>new getstatic putstatic invokestatic 指令，访问final变量除外</li>
<li>java.lang.reflect对类进行反射调用时</li>
<li>初始化子类的时候，父类首先初始化</li>
<li>虚拟机启动时，被执行的主类必须初始化</li>
<li>动态语言支持java.lang.invoke.MethodHandle解析的结果为REF_getstatic REF_putstatic REF_invokestatic 的方法句柄时，该类必须初始化</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazyLoading</span> </span>&#123; <span class="hljs-comment">//严格讲应该叫lazy initialzing，因为java虚拟机规范并没有严格规定什么时候必须loading,但严格规定了什么时候initialzing</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//P p;</span><br>        <span class="hljs-comment">//X x = new X();</span><br>        <span class="hljs-comment">//System.out.println(P.i);</span><br>        <span class="hljs-comment">//System.out.println(P.j);</span><br>        Class.forName(<span class="hljs-string">&quot;com.mashibing.jvm.c2_classloader.LazyLoading$P&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">P</span> </span>&#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> i = <span class="hljs-number">8</span>;<br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> j = <span class="hljs-number">9</span>;<br>        <span class="hljs-keyword">static</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;P&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">X</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">P</span> </span>&#123;<br>        <span class="hljs-keyword">static</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;X&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="九、总结"><a href="#九、总结" class="headerlink" title="九、总结"></a>九、总结</h5><p>类加载-初始化</p>
<p>加载过程</p>
<ul>
<li>Loading<ul>
<li>双亲委派为了安全</li>
<li>LazyLoading物种情况</li>
<li>ClassLoader的源码<ul>
<li>findInCache -&gt; parent.loadClass -&gt; findClass()</li>
</ul>
</li>
<li>自定义类加载器<ul>
<li>1.extends ClassLoader</li>
<li>2.overwrite findClass() -&gt; defineClass(byte[] -&gt; Class clazz)</li>
<li>3.加密</li>
</ul>
</li>
<li>混合执行 编译执行 解释执行<ul>
<li>检测热点代码：-XX:CompileThreshold = 10000</li>
</ul>
</li>
</ul>
</li>
<li>Linking<ul>
<li>1.Verification</li>
<li>2.Preparation</li>
<li>3.Resolution</li>
</ul>
</li>
<li>Initializing</li>
</ul>
<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2021/04/19/JVM/03-JVM%E5%9F%BA%E7%A1%80/">← Prev 03-JVM基础</a><span style="color: #fe2"> | </span><a href="/2021/04/18/JVM/01-JVM%E5%9F%BA%E7%A1%80/">01-JVM基础 Next →</a><hr></div><div id="bottom-btn"><a id="to-top" href="#post-title" title="to top">∧</a></div><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: ''
 , appKey: ''
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://scpic.chinaz.net/files/pic/pic9/202104/apic31860.jpg" alt="Logo"></a><h1 id="Dr"><a href="/"> Dr.浅陌</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">27</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">8</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">8</span></div></section></div><div id="aside-block" style="order: -1"></div><footer style="text-align: right"><wbr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>