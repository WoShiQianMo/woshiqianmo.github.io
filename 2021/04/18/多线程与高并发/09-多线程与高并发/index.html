<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>09-多线程与高并发 | Hexo</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a></nav></header><main style="flex-direction: row-reverse"><article><div id="post-bg"><div id="post-title"><h1>09-多线程与高并发</h1><hr></div><div id="post-content"><h5 id="一、ParallelStreamApi"><a href="#一、ParallelStreamApi" class="headerlink" title="一、ParallelStreamApi"></a>一、ParallelStreamApi</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">T13_ParallelStreamAPI</span> </span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		List&lt;Integer&gt; nums = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>		Random r = <span class="hljs-keyword">new</span> Random();<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10000</span>; i++) nums.add(<span class="hljs-number">1000000</span> + r.nextInt(<span class="hljs-number">1000000</span>));<br>		<br>		<span class="hljs-comment">//System.out.println(nums);</span><br>		<br>		<span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>		nums.forEach(v-&gt;isPrime(v));<br>		<span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>		System.out.println(end - start);<br>		<br>		<span class="hljs-comment">//使用parallel stream api</span><br>		<br>		start = System.currentTimeMillis();<br>		nums.parallelStream().forEach(T13_ParallelStreamAPI::isPrime);<br>		end = System.currentTimeMillis();<br>		<br>		System.out.println(end - start);<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isPrime</span><span class="hljs-params">(<span class="hljs-keyword">int</span> num)</span> </span>&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">2</span>; i&lt;=num/<span class="hljs-number">2</span>; i++) &#123;<br>			<span class="hljs-keyword">if</span>(num % i == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>线程中有个方法调用了native方法，阻塞，但是线程显示还是runnable状态，可以通过设置时间，多长时间没有返回结果，直接释方法</p>
<h5 id="二、JMH"><a href="#二、JMH" class="headerlink" title="二、JMH"></a>二、JMH</h5><ul>
<li>Java Microbenchmark Harness java方法性能测试</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://openjdk.java.net/projects/code-tools/jmh/">JMH官网</a></p>
<h6 id="1-创建JMH测试"><a href="#1-创建JMH测试" class="headerlink" title="1. 创建JMH测试"></a>1. 创建JMH测试</h6><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>   &lt;project xmlns=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br>            xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>            xsi:schemaLocation=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;<br>       &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br>   <br>       &lt;properties&gt;<br>           &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;<br>           &lt;encoding&gt;UTF-8&lt;/encoding&gt;<br>           &lt;java.version&gt;1.8&lt;/java.version&gt;<br>           &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;<br>           &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;<br>       &lt;/properties&gt;<br>   <br>       &lt;groupId&gt;mashibing.com&lt;/groupId&gt;<br>       &lt;artifactId&gt;HelloJMH2&lt;/artifactId&gt;<br>       &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;<br>   <br>   <br>       &lt;dependencies&gt;<br>           &lt;!-- https:<span class="hljs-comment">//mvnrepository.com/artifact/org.openjdk.jmh/jmh-core --&gt;</span><br>           &lt;dependency&gt;<br>               &lt;groupId&gt;org.openjdk.jmh&lt;/groupId&gt;<br>               &lt;artifactId&gt;jmh-core&lt;/artifactId&gt;<br>               &lt;version&gt;1.21&lt;/version&gt;<br>           &lt;/dependency&gt;<br>   <br>           &lt;!-- https:<span class="hljs-comment">//mvnrepository.com/artifact/org.openjdk.jmh/jmh-generator-annprocess --&gt;</span><br>           &lt;dependency&gt;<br>               &lt;groupId&gt;org.openjdk.jmh&lt;/groupId&gt;<br>               &lt;artifactId&gt;jmh-generator-annprocess&lt;/artifactId&gt;<br>               &lt;version&gt;1.21&lt;/version&gt;<br>               &lt;scope&gt;test&lt;/scope&gt;<br>           &lt;/dependency&gt;<br>       &lt;/dependencies&gt;<br>   &lt;/project&gt;<br></code></pre></td></tr></table></figure>

<h6 id="2-idea安装JMH插件-JMH-plugin-v1-0-3"><a href="#2-idea安装JMH插件-JMH-plugin-v1-0-3" class="headerlink" title="2. idea安装JMH插件 JMH plugin v1.0.3"></a>2. idea安装JMH插件 JMH plugin v1.0.3</h6><h6 id="3-由于用到了注解，打开运行程序注解配置"><a href="#3-由于用到了注解，打开运行程序注解配置" class="headerlink" title="3. 由于用到了注解，打开运行程序注解配置"></a>3. 由于用到了注解，打开运行程序注解配置</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">&gt; compiler -&gt; Annotation Processors -&gt; Enable Annotation Processing<br></code></pre></td></tr></table></figure>

<h6 id="4-定义需要测试类PS-ParallelStream"><a href="#4-定义需要测试类PS-ParallelStream" class="headerlink" title="4. 定义需要测试类PS (ParallelStream)"></a>4. 定义需要测试类PS (ParallelStream)</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PS</span> </span>&#123;<br>	<span class="hljs-keyword">static</span> List&lt;Integer&gt; nums = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>	<span class="hljs-keyword">static</span> &#123;<br>		Random r = <span class="hljs-keyword">new</span> Random();<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) nums.add(<span class="hljs-number">1000000</span> + r.nextInt(<span class="hljs-number">1000000</span>));<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">foreach</span><span class="hljs-params">()</span> </span>&#123;<br>		nums.forEach(v-&gt;isPrime(v));<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parallel</span><span class="hljs-params">()</span> </span>&#123;<br>		nums.parallelStream().forEach(PS::isPrime);<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isPrime</span><span class="hljs-params">(<span class="hljs-keyword">int</span> num)</span> </span>&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">2</span>; i&lt;=num/<span class="hljs-number">2</span>; i++) &#123;<br>			<span class="hljs-keyword">if</span>(num % i == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="5-写单元测试"><a href="#5-写单元测试" class="headerlink" title="5. 写单元测试"></a>5. 写单元测试</h6><p>这个测试类一定要在test package下面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.openjdk.jmh.annotations.Benchmark;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.jupiter.api.Assertions.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PSTest</span> </span>&#123;<br>    <span class="hljs-meta">@Benchmark</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testForEach</span><span class="hljs-params">()</span> </span>&#123;<br>        PS.foreach();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="6-运行测试类，如果遇到下面的错误："><a href="#6-运行测试类，如果遇到下面的错误：" class="headerlink" title="6. 运行测试类，如果遇到下面的错误："></a>6. 运行测试类，如果遇到下面的错误：</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">ERROR: org.openjdk.jmh.runner.RunnerException: ERROR: <span class="hljs-function">Exception <span class="hljs-keyword">while</span> trying to acquire the JMH <span class="hljs-title">lock</span> <span class="hljs-params">(C:\WINDOWS\/jmh.lock)</span>: C:\WINDOWS\jmh.<span class="hljs-title">lock</span> <span class="hljs-params">(拒绝访问。)</span>, exiting. Use -Djmh.ignoreLock</span>=<span class="hljs-keyword">true</span> to forcefully <span class="hljs-keyword">continue</span>.<br>	at org.openjdk.jmh.runner.Runner.run(Runner.java:<span class="hljs-number">216</span>)<br>	at org.openjdk.jmh.Main.main(Main.java:<span class="hljs-number">71</span>)<br></code></pre></td></tr></table></figure>

<p>这个错误是因为JMH运行需要访问系统的TMP目录，解决办法是：</p>
<p>打开RunConfiguration -&gt; Environment Variables -&gt; include system environment viables</p>
<h6 id="7-阅读测试报告"><a href="#7-阅读测试报告" class="headerlink" title="7. 阅读测试报告"></a>7. 阅读测试报告</h6><h6 id="JMH中的基本概念"><a href="#JMH中的基本概念" class="headerlink" title="JMH中的基本概念"></a>JMH中的基本概念</h6><ul>
<li>Warmup 预热，由于JVM中对于特定代码会存在优化（本地化），预热对于测试结果很重要</li>
<li>Mesurement 总共执行多少次测试</li>
<li>Timeout</li>
<li>Threads 线程数，由fork指定</li>
<li>Benchmark mode 基准测试的模式</li>
<li>Benchmark 测试哪一段代码</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://hg.openjdk.java.net/code-tools/jmh/file/tip/jmh-samples/src/main/java/org/openjdk/jmh/samples/">官方样例</a></p>
<h5 id="三、Disruptor介绍"><a href="#三、Disruptor介绍" class="headerlink" title="三、Disruptor介绍"></a>三、Disruptor介绍</h5><p><a target="_blank" rel="noopener" href="http://lmax-exchange.github.io/disruptor/">主页</a>、<a target="_blank" rel="noopener" href="https://github.com/LMAX-Exchange/disruptor">源码</a>、<a target="_blank" rel="noopener" href="https://github.com/LMAX-Exchange/disruptor/wiki/Getting-Started">GettingStarted</a>、<a target="_blank" rel="noopener" href="http://lmax-exchange.github.io/disruptor/docs/index.html">api</a>、<a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/com.lmax/disruptor">maven</a></p>
<ul>
<li>disruptor - 分裂、瓦解 内存中存放队列</li>
<li>disruptor 特点：<ul>
<li>对比ConcurrentLinkedQueue : 链表实现 </li>
<li>JDK中没有ConcurrentArrayQueue</li>
<li>Disruptor是数组实现的</li>
<li>无锁，高并发，使用环形Buffer，直接覆盖（不用清除）旧的数据，降低GC频率</li>
<li>实现了基于事件的生产者消费者模式（观察者模式）</li>
</ul>
</li>
<li>速度最快的MQ</li>
<li>性能极高，无锁cas，单机支持高并发</li>
</ul>
<h6 id="RingBuffer"><a href="#RingBuffer" class="headerlink" title="RingBuffer"></a>RingBuffer</h6><p>环形队列</p>
<p>RingBuffer的序号，指向下一个可用的元素</p>
<p>采用数组实现，没有首尾指针</p>
<p>对比ConcurrentLinkedQueue，用数组实现的速度更快</p>
<blockquote>
<p>假如长度为8，当添加到第12个元素的时候在哪个序号上呢？用12%8决定</p>
<p>当Buffer被填满的时候到底是覆盖还是等待，由Producer决定</p>
<p>长度设为2的n次幂，利于二进制计算，例如：12%8 = 12 &amp; (8 - 1) pos = num &amp; (size -1)</p>
</blockquote>
<h6 id="Disruptor开发步骤"><a href="#Disruptor开发步骤" class="headerlink" title="Disruptor开发步骤"></a>Disruptor开发步骤</h6><ul>
<li><p>1.定义Event - 队列中需要处理的元素</p>
</li>
<li><p>2.定义Event工厂，用于填充队列</p>
</li>
<li><blockquote>
<p>这里牵扯到效率问题：disruptor初始化的时候，会调用Event工厂，对ringBuffer进行内存的提前分配</p>
<p>GC产频率会降低</p>
</blockquote>
</li>
<li><p>3.定义EventHandler（消费者），处理容器中的元素</p>
</li>
</ul>
<h6 id="事件发布模板"><a href="#事件发布模板" class="headerlink" title="事件发布模板"></a>事件发布模板</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">long</span> sequence = ringBuffer.next();  <span class="hljs-comment">// Grab the next sequence</span><br><span class="hljs-keyword">try</span> &#123;<br>    LongEvent event = ringBuffer.get(sequence); <span class="hljs-comment">// Get the entry in the Disruptor</span><br>    <span class="hljs-comment">// for the sequence</span><br>    event.set(<span class="hljs-number">8888L</span>);  <span class="hljs-comment">// Fill with data</span><br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    ringBuffer.publish(sequence);<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="使用EventTranslator发布事件"><a href="#使用EventTranslator发布事件" class="headerlink" title="使用EventTranslator发布事件"></a>使用EventTranslator发布事件</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//===============================================================</span><br>        EventTranslator&lt;LongEvent&gt; translator1 = <span class="hljs-keyword">new</span> EventTranslator&lt;LongEvent&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">translateTo</span><span class="hljs-params">(LongEvent event, <span class="hljs-keyword">long</span> sequence)</span> </span>&#123;<br>                event.set(<span class="hljs-number">8888L</span>);<br>            &#125;<br>        &#125;;<br><br>        ringBuffer.publishEvent(translator1);<br><br>        <span class="hljs-comment">//===============================================================</span><br>        EventTranslatorOneArg&lt;LongEvent, Long&gt; translator2 = <span class="hljs-keyword">new</span> EventTranslatorOneArg&lt;LongEvent, Long&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">translateTo</span><span class="hljs-params">(LongEvent event, <span class="hljs-keyword">long</span> sequence, Long l)</span> </span>&#123;<br>                event.set(l);<br>            &#125;<br>        &#125;;<br><br>        ringBuffer.publishEvent(translator2, <span class="hljs-number">7777L</span>);<br><br>        <span class="hljs-comment">//===============================================================</span><br>        EventTranslatorTwoArg&lt;LongEvent, Long, Long&gt; translator3 = <span class="hljs-keyword">new</span> EventTranslatorTwoArg&lt;LongEvent, Long, Long&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">translateTo</span><span class="hljs-params">(LongEvent event, <span class="hljs-keyword">long</span> sequence, Long l1, Long l2)</span> </span>&#123;<br>                event.set(l1 + l2);<br>            &#125;<br>        &#125;;<br><br>        ringBuffer.publishEvent(translator3, <span class="hljs-number">10000L</span>, <span class="hljs-number">10000L</span>);<br><br>        <span class="hljs-comment">//===============================================================</span><br>        EventTranslatorThreeArg&lt;LongEvent, Long, Long, Long&gt; translator4 = <span class="hljs-keyword">new</span> EventTranslatorThreeArg&lt;LongEvent, Long, Long, Long&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">translateTo</span><span class="hljs-params">(LongEvent event, <span class="hljs-keyword">long</span> sequence, Long l1, Long l2, Long l3)</span> </span>&#123;<br>                event.set(l1 + l2 + l3);<br>            &#125;<br>        &#125;;<br><br>        ringBuffer.publishEvent(translator4, <span class="hljs-number">10000L</span>, <span class="hljs-number">10000L</span>, <span class="hljs-number">1000L</span>);<br><br>        <span class="hljs-comment">//===============================================================</span><br>        EventTranslatorVararg&lt;LongEvent&gt; translator5 = <span class="hljs-keyword">new</span> EventTranslatorVararg&lt;LongEvent&gt;() &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">translateTo</span><span class="hljs-params">(LongEvent event, <span class="hljs-keyword">long</span> sequence, Object... objects)</span> </span>&#123;<br>                <span class="hljs-keyword">long</span> result = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">for</span>(Object o : objects) &#123;<br>                    <span class="hljs-keyword">long</span> l = (Long)o;<br>                    result += l;<br>                &#125;<br>                event.set(result);<br>            &#125;<br>        &#125;;<br><br>        ringBuffer.publishEvent(translator5, <span class="hljs-number">10000L</span>, <span class="hljs-number">10000L</span>, <span class="hljs-number">10000L</span>, <span class="hljs-number">10000L</span>);<br></code></pre></td></tr></table></figure>

<h6 id="使用Lamda表达式"><a href="#使用Lamda表达式" class="headerlink" title="使用Lamda表达式"></a>使用Lamda表达式</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.lmax.disruptor.RingBuffer;<br><span class="hljs-keyword">import</span> com.lmax.disruptor.dsl.Disruptor;<br><span class="hljs-keyword">import</span> com.lmax.disruptor.util.DaemonThreadFactory;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main03</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-comment">// Specify the size of the ring buffer, must be power of 2.</span><br>        <span class="hljs-keyword">int</span> bufferSize = <span class="hljs-number">1024</span>;<br><br>        <span class="hljs-comment">// Construct the Disruptor</span><br>        Disruptor&lt;LongEvent&gt; disruptor = <span class="hljs-keyword">new</span> Disruptor&lt;&gt;(LongEvent::<span class="hljs-keyword">new</span>, bufferSize, DaemonThreadFactory.INSTANCE);<br><br>        <span class="hljs-comment">// Connect the handler</span><br>        disruptor.handleEventsWith((event, sequence, endOfBatch) -&gt; System.out.println(<span class="hljs-string">&quot;Event: &quot;</span> + event));<br><br>        <span class="hljs-comment">// Start the Disruptor, starts all threads running</span><br>        disruptor.start();<br><br>        <span class="hljs-comment">// Get the ring buffer from the Disruptor to be used for publishing.</span><br>        RingBuffer&lt;LongEvent&gt; ringBuffer = disruptor.getRingBuffer();<br><br><br>        ringBuffer.publishEvent((event, sequence) -&gt; event.set(<span class="hljs-number">10000L</span>));<br><br>        System.in.read();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="ProducerType生产者线程模式"><a href="#ProducerType生产者线程模式" class="headerlink" title="ProducerType生产者线程模式"></a>ProducerType生产者线程模式</h6><blockquote>
<p>ProducerType有两种模式 Producer.MULTI和Producer.SINGLE</p>
<p>默认是MULTI，表示在多线程模式下产生sequence</p>
<p>如果确认是单线程生产者，那么可以指定SINGLE，效率会提升</p>
<p>如果是多个生产者（多线程），但模式指定为SINGLE，会出什么问题呢？</p>
</blockquote>
<h6 id="等待策略"><a href="#等待策略" class="headerlink" title="等待策略"></a>等待策略</h6><p>1，(常用）BlockingWaitStrategy：通过线程阻塞的方式，等待生产者唤醒，被唤醒后，再循环检查依赖的sequence是否已经消费。</p>
<p>2，BusySpinWaitStrategy：线程一直自旋等待，可能比较耗cpu</p>
<p>3，LiteBlockingWaitStrategy：线程阻塞等待生产者唤醒，与BlockingWaitStrategy相比，区别在signalNeeded.getAndSet,如果两个线程同时访问一个访问waitfor,一个访问signalAll时，可以减少lock加锁次数.</p>
<p>4，LiteTimeoutBlockingWaitStrategy：与LiteBlockingWaitStrategy相比，设置了阻塞时间，超过时间后抛异常。</p>
<p>5，PhasedBackoffWaitStrategy：根据时间参数和传入的等待策略来决定使用哪种等待策略</p>
<p>6，TimeoutBlockingWaitStrategy：相对于BlockingWaitStrategy来说，设置了等待时间，超过后抛异常7，（常用）YieldingWaitStrategy：尝试100次，然后Thread.yield()让出cpu</p>
<p>8,（常用）SleepingWaitStrategy : sleep</p>
<h6 id="消费者异常处理"><a href="#消费者异常处理" class="headerlink" title="消费者异常处理"></a>消费者异常处理</h6><p>默认：disruptor.setDefaultExceptionHandler()</p>
<p>覆盖：disruptor.handleExceptionFor().with()</p>
<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2021/04/18/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/08-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/">08-多线程与高并发 Next →</a><hr></div><div id="bottom-btn"><a id="to-top" href="#post-title" title="to top">∧</a></div><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: ''
 , appKey: ''
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://scpic.chinaz.net/files/pic/pic9/202104/apic31860.jpg" alt="Logo"></a><h1 id="Dr"><a href="/"> Dr.浅陌</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">11</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">2</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">2</span></div></section></div><div id="aside-block" style="order: -1"></div><footer style="text-align: right"><wbr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>