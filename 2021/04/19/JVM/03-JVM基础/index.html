<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>03-JVM基础 | Hexo</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a></nav></header><main style="flex-direction: row-reverse"><article><div id="post-bg"><div id="post-title"><h1>03-JVM基础</h1><hr></div><div id="post-content"><h5 id="一、ClassLoader自定义parent"><a href="#一、ClassLoader自定义parent" class="headerlink" title="一、ClassLoader自定义parent"></a>一、ClassLoader自定义parent</h5><p>默认parent是 getSystemClassLoader(); -&gt; AppClassLoader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MSBClassLoader parent = <span class="hljs-keyword">new</span> MSBClassLoader();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ClassLoader</span> </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyLoader</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">super</span>(parent);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="二、如何打破双亲委派模型"><a href="#二、如何打破双亲委派模型" class="headerlink" title="二、如何打破双亲委派模型"></a>二、如何打破双亲委派模型</h5><p>重写loadClass，何时打破双亲委派模型？</p>
<ul>
<li>JDK1.2之前,自定义ClassLoader都必须重写loadClass()</li>
<li>ThreadContextClassLoader可以实现基础类调用实现类代码，通过thread.setContextClassLoader指定</li>
<li>热启动，热部署<ul>
<li>1.osgi tomcat 都有自己的模块指定classloader(可以加载同一类库的不同版本)</li>
<li>当webapplication部署时候，如果一个项目有a.jar 1.0版本，另外一个项目有a.jar 2.0版本，使用双亲委派模型，不会加载第二次</li>
</ul>
</li>
</ul>
<p>没有打破双亲委派模型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassReloading</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        MSBClassLoader msbClassLoader = <span class="hljs-keyword">new</span> MSBClassLoader();<br>        Class clazz = msbClassLoader.loadClass(<span class="hljs-string">&quot;com.mashibing.jvm.Hello&quot;</span>);<br><br>        msbClassLoader = <span class="hljs-keyword">null</span>;<br>        System.out.println(clazz.hashCode());<br><br>        msbClassLoader = <span class="hljs-keyword">null</span>;<br><br>        msbClassLoader = <span class="hljs-keyword">new</span> T006_MSBClassLoader();<br>        Class clazz1 = msbClassLoader.loadClass(<span class="hljs-string">&quot;com.mashibing.jvm.Hello&quot;</span>);<br>        System.out.println(clazz1.hashCode());<br>        System.out.println(clazz == clazz1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>打破双亲委派模型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.mashibing.jvm.Hello;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassReloading</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ClassLoader</span> </span>&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>            <br>            File f = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;C:/work/ijprojects/JVM/out/production/JVM/&quot;</span> + name.replace(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>).concat(<span class="hljs-string">&quot;.class&quot;</span>));<br><br>            <span class="hljs-keyword">if</span>(!f.exists()) <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.loadClass(name);<br><br>            <span class="hljs-keyword">try</span> &#123;<br><br>                InputStream is = <span class="hljs-keyword">new</span> FileInputStream(f);<br><br>                <span class="hljs-keyword">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[is.available()];<br>                is.read(b);<br>                <span class="hljs-keyword">return</span> defineClass(name, b, <span class="hljs-number">0</span>, b.length);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.loadClass(name);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        MyLoader m = <span class="hljs-keyword">new</span> MyLoader();<br>        Class clazz = m.loadClass(<span class="hljs-string">&quot;com.mashibing.jvm.Hello&quot;</span>);<br><br>        m = <span class="hljs-keyword">new</span> MyLoader();<br>        Class clazzNew = m.loadClass(<span class="hljs-string">&quot;com.mashibing.jvm.Hello&quot;</span>);<br>        System.out.println(clazz == clazzNew);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="三、Linking"><a href="#三、Linking" class="headerlink" title="三、Linking"></a>三、Linking</h5><ul>
<li>1.Verification<ul>
<li>验证文件是否符合JVM规定</li>
</ul>
</li>
<li>2.Preparation<ul>
<li>静态成员变量赋默认值</li>
</ul>
</li>
<li>3.Resolution<ul>
<li>将类、方法、属性等符号引用解析为直接引用常量池中的各种符号引用解析为指针、偏移量等内存地址的直接引用</li>
</ul>
</li>
</ul>
<h5 id="四、Initalizing"><a href="#四、Initalizing" class="headerlink" title="四、Initalizing"></a>四、Initalizing</h5><p>调用类初始化代码，给静态变量赋初始值</p>
<ul>
<li>load - 默认值 - 初始值</li>
<li>new - 申请内存 - 默认值 - 初始值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassLoadingProcedure</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        System.out.println(T.count);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">T</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T t = <span class="hljs-keyword">new</span> T(); <span class="hljs-comment">// null</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> count = <span class="hljs-number">2</span>; <span class="hljs-comment">//0</span><br><br>    <span class="hljs-comment">//private int m = 8;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">T</span><span class="hljs-params">()</span> </span>&#123;<br>        count ++;<br>        <span class="hljs-comment">//System.out.println(&quot;--&quot; + count);</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>单例模式 双重检查  必须加volatile 防止指令重排序</p>
<p><img src="https://note.youdao.com/yws/public/resource/440b71dabe81b5ef9cc60f5976a645a6/xmlnote/67358A67082B4C7D86DA1727C978FFA6/89" alt="指令重排序"></p>
<h5 id="五、JMM-（Java-Memory-Model）"><a href="#五、JMM-（Java-Memory-Model）" class="headerlink" title="五、JMM （Java Memory Model）"></a>五、JMM （Java Memory Model）</h5><h6 id="5-1-硬件层的并发优化基础知识"><a href="#5-1-硬件层的并发优化基础知识" class="headerlink" title="5.1 硬件层的并发优化基础知识"></a>5.1 硬件层的并发优化基础知识</h6><p><img src="https://note.youdao.com/yws/public/resource/440b71dabe81b5ef9cc60f5976a645a6/xmlnote/C8E32C8A33E94B35A4B51B516E2F6808/30" alt="存储器的层次结构"></p>
<p><img src="https://note.youdao.com/yws/public/resource/440b71dabe81b5ef9cc60f5976a645a6/xmlnote/BD52DF80F7FE47ABB77C4F1A9E73AB8E/53" alt="cache line"></p>
<p><img src="https://note.youdao.com/yws/public/resource/440b71dabe81b5ef9cc60f5976a645a6/xmlnote/CFB39AFA857B42FFB268817CF8473E50/38" alt="多线程一致性的硬件层支持（老CPU使用总线锁）"></p>
<p><img src="https://note.youdao.com/yws/public/resource/440b71dabe81b5ef9cc60f5976a645a6/xmlnote/B1BA0F240BCA44CEA9C8D9DC1A3FADB4/22" alt="MESI Cache一致性协议（新CPU Intel使用）"></p>
<p>其它协议有：MSI、MESI、MOSI、Synapse、Firefly、Dragon</p>
<p>Modified 自己改过</p>
<p>Exclusive 只有自己在用</p>
<p>Shared 别人也读过</p>
<p>Invalid 失效的</p>
<p>读取缓存以cache line 为基本单位，目前64bytes，位于同一缓存行的两个不同数据，被两个不同CPU锁定，产生互相影响的伪共享问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//位于同一个缓存行</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheLinePadding</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">T</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">long</span> x = <span class="hljs-number">0L</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T[] arr = <span class="hljs-keyword">new</span> T[<span class="hljs-number">2</span>];<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        arr[<span class="hljs-number">0</span>] = <span class="hljs-keyword">new</span> T();<br>        arr[<span class="hljs-number">1</span>] = <span class="hljs-keyword">new</span> T();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000_0000L</span>; i++) &#123;<br>                arr[<span class="hljs-number">0</span>].x = i;<br>            &#125;<br>        &#125;);<br><br>        Thread t2 = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000_0000L</span>; i++) &#123;<br>                arr[<span class="hljs-number">1</span>].x = i;<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> start = System.nanoTime();<br>        t1.start();<br>        t2.start();<br>        t1.join();<br>        t2.join();<br>        System.out.println((System.nanoTime() - start)/<span class="hljs-number">100_0000</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//位于不同缓存行</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheLinePadding</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Padding</span> </span>&#123;<br>        <span class="hljs-comment">//缓存行对齐</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">long</span> p1, p2, p3, p4, p5, p6, p7;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Padding</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">long</span> x = <span class="hljs-number">0L</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T[] arr = <span class="hljs-keyword">new</span> T[<span class="hljs-number">2</span>];<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        arr[<span class="hljs-number">0</span>] = <span class="hljs-keyword">new</span> T();<br>        arr[<span class="hljs-number">1</span>] = <span class="hljs-keyword">new</span> T();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000_0000L</span>; i++) &#123;<br>                arr[<span class="hljs-number">0</span>].x = i;<br>            &#125;<br>        &#125;);<br><br>        Thread t2 = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000_0000L</span>; i++) &#123;<br>                arr[<span class="hljs-number">1</span>].x = i;<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> start = System.nanoTime();<br>        t1.start();<br>        t2.start();<br>        t1.join();<br>        t2.join();<br>        System.out.println((System.nanoTime() - start)/<span class="hljs-number">100_0000</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>disruptor 单机效率最高的消息对列</p>
<p><img src="https://note.youdao.com/yws/public/resource/440b71dabe81b5ef9cc60f5976a645a6/xmlnote/44C9DF13CBD443B1A37D98C2F4CC8650/85" alt="disruptor"></p>
<p>使用缓存行的对齐，可以提高效率，但是，浪费空间</p>
<h6 id="5-2-乱序问题"><a href="#5-2-乱序问题" class="headerlink" title="5.2 乱序问题"></a>5.2 乱序问题</h6><p>CPU为了提高指令执行效率，会在一条指令执行过程中（比如去内存读数据（慢100倍）），去同时执行另一条指令，前提是，两条指令没有依赖关系</p>
<p><a href="%5D(https://www.cnblogs.com/liushaodong/p/4777308.html)https://www.cnblogs.com/liushaodong/p/4777308.html">现代cpu的合并写技术对程序的影响</a></p>
<p>写操作也可以进行合并 WCBuffer 比L1缓存速度都快 只有4个位置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WriteCombining</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ITERATIONS = Integer.MAX_VALUE;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ITEMS = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">24</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MASK = ITEMS - <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] arrayA = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[ITEMS];<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] arrayB = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[ITEMS];<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] arrayC = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[ITEMS];<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] arrayD = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[ITEMS];<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] arrayE = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[ITEMS];<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] arrayF = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[ITEMS];<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String[] args)</span> </span>&#123;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">3</span>; i++) &#123;<br>            System.out.println(i + <span class="hljs-string">&quot; SingleLoop duration (ns) = &quot;</span> + runCaseOne());<br>            System.out.println(i + <span class="hljs-string">&quot; SplitLoop  duration (ns) = &quot;</span> + runCaseTwo());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">runCaseOne</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">long</span> start = System.nanoTime();<br>        <span class="hljs-keyword">int</span> i = ITERATIONS;<br><br>        <span class="hljs-keyword">while</span> (--i != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">int</span> slot = i &amp; MASK;<br>            <span class="hljs-keyword">byte</span> b = (<span class="hljs-keyword">byte</span>) i;<br>            arrayA[slot] = b;<br>            arrayB[slot] = b;<br>            arrayC[slot] = b;<br>            arrayD[slot] = b;<br>            arrayE[slot] = b;<br>            arrayF[slot] = b;<br>        &#125;<br>        <span class="hljs-keyword">return</span> System.nanoTime() - start;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">runCaseTwo</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">long</span> start = System.nanoTime();<br>        <span class="hljs-keyword">int</span> i = ITERATIONS;<br>        <span class="hljs-keyword">while</span> (--i != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">int</span> slot = i &amp; MASK;<br>            <span class="hljs-keyword">byte</span> b = (<span class="hljs-keyword">byte</span>) i;<br>            arrayA[slot] = b;<br>            arrayB[slot] = b;<br>            arrayC[slot] = b;<br>        &#125;<br>        i = ITERATIONS;<br>        <span class="hljs-keyword">while</span> (--i != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">int</span> slot = i &amp; MASK;<br>            <span class="hljs-keyword">byte</span> b = (<span class="hljs-keyword">byte</span>) i;<br>            arrayD[slot] = b;<br>            arrayE[slot] = b;<br>            arrayF[slot] = b;<br>        &#125;<br>        <span class="hljs-keyword">return</span> System.nanoTime() - start;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>乱序执行的证明：</p>
<p><a target="_blank" rel="noopener" href="https://preshing.com/20120515/memory-reordering-caught-in-the-act/">原始参考</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Disorder</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> a = <span class="hljs-number">0</span>, b =<span class="hljs-number">0</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(;;) &#123;<br>            i++;<br>            x = <span class="hljs-number">0</span>; y = <span class="hljs-number">0</span>;<br>            a = <span class="hljs-number">0</span>; b = <span class="hljs-number">0</span>;<br>            Thread one = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;<br>                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                    <span class="hljs-comment">//由于线程one先启动，下面这句话让它等一等线程two. 读着可根据自己电脑的实际性能适当调整等待时间.</span><br>                    <span class="hljs-comment">//shortWait(100000);</span><br>                    a = <span class="hljs-number">1</span>;<br>                    x = b;<br>                &#125;<br>            &#125;);<br><br>            Thread other = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;<br>                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                    b = <span class="hljs-number">1</span>;<br>                    y = a;<br>                &#125;<br>            &#125;);<br>            one.start();other.start();<br>            one.join();other.join();<br>            String result = <span class="hljs-string">&quot;第&quot;</span> + i + <span class="hljs-string">&quot;次 (&quot;</span> + x + <span class="hljs-string">&quot;,&quot;</span> + y + <span class="hljs-string">&quot;）&quot;</span>;<br>            <span class="hljs-keyword">if</span>(x == <span class="hljs-number">0</span> &amp;&amp; y == <span class="hljs-number">0</span>) &#123;<br>                System.err.println(result);<br>                <span class="hljs-keyword">break</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//System.out.println(result);</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shortWait</span><span class="hljs-params">(<span class="hljs-keyword">long</span> interval)</span></span>&#123;<br>        <span class="hljs-keyword">long</span> start = System.nanoTime();<br>        <span class="hljs-keyword">long</span> end;<br>        <span class="hljs-keyword">do</span>&#123;<br>            end = System.nanoTime();<br>        &#125;<span class="hljs-keyword">while</span>(start + interval &gt;= end);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果顺序执行：xy结果可能只有 01 10 11</p>
<p><img src="https://note.youdao.com/yws/public/resource/440b71dabe81b5ef9cc60f5976a645a6/xmlnote/924461B6E26F4C0FB454988DDB85E1D8/90" alt="乱序结果"> </p>
<h6 id="5-3-如何保证有序性？"><a href="#5-3-如何保证有序性？" class="headerlink" title="5.3 如何保证有序性？"></a>5.3 如何保证有序性？</h6><p>x86在硬件层面：有序性保障CPU内存屏障 </p>
<ul>
<li>sfence：store 在sfence指令前的写操作当必须在sfence指令后的写操作前完成</li>
<li>Ifence：load 在Ifence指令前的读操作当必须在sfence指令后的读操作前完成</li>
<li>mfence：mix在mfence指令前的读写操作当必须在sfence指令后的读写操作前完成</li>
</ul>
<p>有序性保障intel lock汇编指令(java 的汇编指令)</p>
<p>JMM模型与内存屏障：Java内存模型中volatile变量在写操作之后会插入一个store屏障，在读操作之前会插入一个load屏障。一个类的final字段会在初始化后插入一个store屏障，来确保final字段在构造函数初始化完成并可被使用时可见</p>
<p>JSR内存屏障：</p>
<ul>
<li>LoadLoad屏障：在Load2及后续读取操作要读取的数据被访问前，保证Load1要读取的数据被读取完毕。</li>
<li>StoreStore屏障：对于这样的语句Store1; StoreStore; Store2，在Store2及后续写入操作执行前，保证Store1的写入操作对其它处理器可见。</li>
<li>LoadStore屏障：对于这样的语句Load1; LoadStore; Store2，在Store2及后续写入操作被刷出前，保证Load1要读取的数据被读取完毕。</li>
<li>StoreLoad屏障：对于这样的语句Store1; StoreLoad; Load2，在Load2及后续所有读取操作执行前，保证Store1的写入对所有处理器可见。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestVolatile</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> i;<br>    <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> j;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>volatile的实现细节：</p>
<ul>
<li>字节码层面 ACC_VOLATILE</li>
<li>JVM层面 volatile内存区的读写 都加屏障<ul>
<li>StoreStoreBarrier</li>
<li>volatile 写操作</li>
<li>StoreLoadBarrier</li>
<li>LoadLoadBarrier</li>
<li>volatile 读操作</li>
<li>LoadStoreBarrier</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26222859/article/details/52235930">OS和硬件层面</a> hsdis - HotSpot Dis Assembler windows lock 指令实现 | MESI实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestSync</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">m</span><span class="hljs-params">()</span> </span>&#123;<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">n</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>synchronized的实现细节：</p>
<ul>
<li>字节码层面 ACC_SYNCHRONIZED monitorenter monitorexit</li>
<li>JVM层面 C C++ 调用了操作系统提供的同步机制</li>
<li>OS和硬件层面 X86 : lock cmpxchg / xxx <ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/21aspnet/article/details/88571740">https://blog.csdn.net/21aspnet/article/details/88571740</a></li>
</ul>
</li>
</ul>
<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2021/04/21/JVM/04-JVM%E5%9F%BA%E7%A1%80/">← Prev 04-JVM基础</a><span style="color: #fe2"> | </span><a href="/2021/04/18/JVM/02-JVM%E5%9F%BA%E7%A1%80/">02-JVM基础 Next →</a><hr></div><div id="bottom-btn"><a id="to-top" href="#post-title" title="to top">∧</a></div><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: ''
 , appKey: ''
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://scpic.chinaz.net/files/pic/pic9/202104/apic31860.jpg" alt="Logo"></a><h1 id="Dr"><a href="/"> Dr.浅陌</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">20</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">4</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">4</span></div></section></div><div id="aside-block" style="order: -1"></div><footer style="text-align: right"><wbr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>