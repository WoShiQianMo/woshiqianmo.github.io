<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>05-多线程与高并发 | Hexo</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a></nav></header><main style="flex-direction: row-reverse"><article><div id="post-bg"><div id="post-title"><h1>05-多线程与高并发</h1><hr></div><div id="post-content"><h5 id="一、容器"><a href="#一、容器" class="headerlink" title="一、容器"></a>一、容器</h5><p><img src="C:\Users\QianMo\AppData\Roaming\Typora\typora-user-images\1618248906535.png" alt="容器图解"></p>
<h5 id="二、Hashtable-方法都加了synchronized锁-整个方法都加锁"><a href="#二、Hashtable-方法都加了synchronized锁-整个方法都加锁" class="headerlink" title="二、Hashtable 方法都加了synchronized锁  整个方法都加锁"></a>二、Hashtable 方法都加了synchronized锁  整个方法都加锁</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Constants</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> COUNT = <span class="hljs-number">1000000</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> THREAD_COUNT = <span class="hljs-number">100</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.UUID;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestHashtable</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> Hashtable&lt;UUID, UUID&gt; m = <span class="hljs-keyword">new</span> Hashtable&lt;&gt;();<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> count = Constants.COUNT;<br>    <span class="hljs-keyword">static</span> UUID[] keys = <span class="hljs-keyword">new</span> UUID[count];<br>    <span class="hljs-keyword">static</span> UUID[] values = <span class="hljs-keyword">new</span> UUID[count];<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> THREAD_COUNT = Constants.THREAD_COUNT;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>            keys[i] = UUID.randomUUID();<br>            values[i] = UUID.randomUUID();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> start;<br>        <span class="hljs-keyword">int</span> gap = count/THREAD_COUNT;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyThread</span><span class="hljs-params">(<span class="hljs-keyword">int</span> start)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.start = start;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=start; i&lt;start+gap; i++) &#123;<br>                m.put(keys[i], values[i]);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br><br>        Thread[] threads = <span class="hljs-keyword">new</span> Thread[THREAD_COUNT];<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;threads.length; i++) &#123;<br>            threads[i] =<br>            <span class="hljs-keyword">new</span> MyThread(i * (count/THREAD_COUNT));<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            t.start();<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                t.join();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>        System.out.println(end - start);<br><br>        System.out.println(m.size());<br><br>        <span class="hljs-comment">//-----------------------------------</span><br><br>        start = System.currentTimeMillis();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; threads.length; i++) &#123;<br>            threads[i] = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10000000</span>; j++) &#123;<br>                    m.get(keys[<span class="hljs-number">10</span>]);<br>                &#125;<br>            &#125;);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            t.start();<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                t.join();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        end = System.currentTimeMillis();<br>        System.out.println(end - start);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="三、HashMap-方法不加锁"><a href="#三、HashMap-方法不加锁" class="headerlink" title="三、HashMap 方法不加锁"></a>三、HashMap 方法不加锁</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.UUID;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestHashMap</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> HashMap&lt;UUID, UUID&gt; m = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> count = Constants.COUNT;<br>    <span class="hljs-keyword">static</span> UUID[] keys = <span class="hljs-keyword">new</span> UUID[count];<br>    <span class="hljs-keyword">static</span> UUID[] values = <span class="hljs-keyword">new</span> UUID[count];<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> THREAD_COUNT = Constants.THREAD_COUNT;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>            keys[i] = UUID.randomUUID();<br>            values[i] = UUID.randomUUID();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> start;<br>        <span class="hljs-keyword">int</span> gap = count/THREAD_COUNT;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyThread</span><span class="hljs-params">(<span class="hljs-keyword">int</span> start)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.start = start;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=start; i&lt;start+gap; i++) &#123;<br>                m.put(keys[i], values[i]);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br><br>        Thread[] threads = <span class="hljs-keyword">new</span> Thread[THREAD_COUNT];<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;threads.length; i++) &#123;<br>            threads[i] =<br>            <span class="hljs-keyword">new</span> MyThread(i * (count/THREAD_COUNT));<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            t.start();<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                t.join();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>        System.out.println(end - start);<br><br>        System.out.println(m.size());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>Hashtable、Vector</p>
<ul>
<li>基本不用，自带锁</li>
</ul>
<h5 id="四、SynchronizedHashMap-定义了Object-mutex-与Hashtable比较，锁的粒度更细"><a href="#四、SynchronizedHashMap-定义了Object-mutex-与Hashtable比较，锁的粒度更细" class="headerlink" title="四、SynchronizedHashMap 定义了Object mutex 与Hashtable比较，锁的粒度更细"></a>四、SynchronizedHashMap 定义了Object mutex 与Hashtable比较，锁的粒度更细</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Collections;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.UUID;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestSynchronizedHashMap</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> Map&lt;UUID, UUID&gt; m = Collections.synchronizedMap(<span class="hljs-keyword">new</span> HashMap&lt;UUID, UUID&gt;());<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> count = Constants.COUNT;<br>    <span class="hljs-keyword">static</span> UUID[] keys = <span class="hljs-keyword">new</span> UUID[count];<br>    <span class="hljs-keyword">static</span> UUID[] values = <span class="hljs-keyword">new</span> UUID[count];<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> THREAD_COUNT = Constants.THREAD_COUNT;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>            keys[i] = UUID.randomUUID();<br>            values[i] = UUID.randomUUID();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> start;<br>        <span class="hljs-keyword">int</span> gap = count/THREAD_COUNT;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyThread</span><span class="hljs-params">(<span class="hljs-keyword">int</span> start)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.start = start;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=start; i&lt;start+gap; i++) &#123;<br>                m.put(keys[i], values[i]);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br><br>        Thread[] threads = <span class="hljs-keyword">new</span> Thread[THREAD_COUNT];<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;threads.length; i++) &#123;<br>            threads[i] =<br>            <span class="hljs-keyword">new</span> MyThread(i * (count/THREAD_COUNT));<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            t.start();<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                t.join();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>        System.out.println(end - start);<br><br>        System.out.println(m.size());<br><br>        <span class="hljs-comment">//-----------------------------------</span><br><br>        start = System.currentTimeMillis();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; threads.length; i++) &#123;<br>            threads[i] = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10000000</span>; j++) &#123;<br>                    m.get(keys[<span class="hljs-number">10</span>]);<br>                &#125;<br>            &#125;);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            t.start();<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                t.join();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        end = System.currentTimeMillis();<br>        System.out.println(end - start);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="五、ConcurrentHashMap"><a href="#五、ConcurrentHashMap" class="headerlink" title="五、ConcurrentHashMap"></a>五、ConcurrentHashMap</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.UUID;<br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestConcurrentHashMap</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> Map&lt;UUID, UUID&gt; m = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;();<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> count = Constants.COUNT;<br>    <span class="hljs-keyword">static</span> UUID[] keys = <span class="hljs-keyword">new</span> UUID[count];<br>    <span class="hljs-keyword">static</span> UUID[] values = <span class="hljs-keyword">new</span> UUID[count];<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> THREAD_COUNT = Constants.THREAD_COUNT;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>            keys[i] = UUID.randomUUID();<br>            values[i] = UUID.randomUUID();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> start;<br>        <span class="hljs-keyword">int</span> gap = count/THREAD_COUNT;<br><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyThread</span><span class="hljs-params">(<span class="hljs-keyword">int</span> start)</span> </span>&#123;<br>            <span class="hljs-keyword">this</span>.start = start;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=start; i&lt;start+gap; i++) &#123;<br>                m.put(keys[i], values[i]);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br><br>        Thread[] threads = <span class="hljs-keyword">new</span> Thread[THREAD_COUNT];<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;threads.length; i++) &#123;<br>            threads[i] =<br>            <span class="hljs-keyword">new</span> MyThread(i * (count/THREAD_COUNT));<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            t.start();<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                t.join();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>        System.out.println(end - start);<br><br>        System.out.println(m.size());<br><br>        <span class="hljs-comment">//-----------------------------------</span><br><br>        start = System.currentTimeMillis();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; threads.length; i++) &#123;<br>            threads[i] = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10000000</span>; j++) &#123;<br>                    m.get(keys[<span class="hljs-number">10</span>]);<br>                &#125;<br>            &#125;);<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            t.start();<br>        &#125;<br><br>        <span class="hljs-keyword">for</span>(Thread t : threads) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                t.join();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        end = System.currentTimeMillis();<br>        System.out.println(end - start);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>多线程写：Hashtable≈SynchronizedHashMap ≈ ConcurrentHashMap</p>
<p>多线程读：ConcurrentHashMap &gt; Hashtable、SynchronizedHashMap </p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/sunxianghuang/article/details/52221913">跳表（SkipList）及ConcurrentSkipListMap源码解析</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Treemap 红黑树，排好序的</span><br><span class="hljs-comment"> * 没有ConcurrentTreeMap，因为ConcurrentHashMap底层CAS实现，树形结构实现太复杂了</span><br><span class="hljs-comment"> * 使用ConcurrentSkipListMap 使用跳表代替树形结构实现，有序</span><br><span class="hljs-comment"> * ConcurrentHashMap 无序</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">import</span> java.util.*;<br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;<br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentSkipListMap;<br><span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConcurrentMap</span> </span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;();<br>		<span class="hljs-comment">//Map&lt;String, String&gt; map = new ConcurrentSkipListMap&lt;&gt;(); //高并发并且排序</span><br>		<br>		<span class="hljs-comment">//Map&lt;String, String&gt; map = new Hashtable&lt;&gt;();</span><br>		<span class="hljs-comment">//Map&lt;String, String&gt; map = new HashMap&lt;&gt;(); //Collections.synchronizedXXX</span><br>		<span class="hljs-comment">//TreeMap</span><br>		Random r = <span class="hljs-keyword">new</span> Random();<br>		Thread[] ths = <span class="hljs-keyword">new</span> Thread[<span class="hljs-number">100</span>];<br>		CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(ths.length);<br>		<span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;ths.length; i++) &#123;<br>			ths[i] = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>; j&lt;<span class="hljs-number">10000</span>; j++) map.put(<span class="hljs-string">&quot;a&quot;</span> + r.nextInt(<span class="hljs-number">100000</span>), <span class="hljs-string">&quot;a&quot;</span> + r.nextInt(<span class="hljs-number">100000</span>));<br>				latch.countDown();<br>			&#125;);<br>		&#125;<br>		<br>		Arrays.asList(ths).forEach(t-&gt;t.start());<br>		<span class="hljs-keyword">try</span> &#123;<br>			latch.await();<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>		<br>		<span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>		System.out.println(end - start);<br>		System.out.println(map.size());<br><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="六、Vector-内部方法都有-Synchronized"><a href="#六、Vector-内部方法都有-Synchronized" class="headerlink" title="六、Vector 内部方法都有 Synchronized"></a>六、Vector 内部方法都有 Synchronized</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 有N张火车票，每张票都有一个编号</span><br><span class="hljs-comment"> * 同时有10个窗口对外售票</span><br><span class="hljs-comment"> * 请写一个模拟程序</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 分析下面的程序可能会产生哪些问题？</span><br><span class="hljs-comment"> * 重复销售？超量销售？</span><br><span class="hljs-comment"> * ArrayList线程不安全，出现超卖问题</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketSeller</span> </span>&#123;<br>	<span class="hljs-keyword">static</span> List&lt;String&gt; tickets = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>	<br>	<span class="hljs-keyword">static</span> &#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10000</span>; i++) tickets.add(<span class="hljs-string">&quot;票编号：&quot;</span> + i);<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++) &#123;<br>			<span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>				<span class="hljs-keyword">while</span>(tickets.size() &gt; <span class="hljs-number">0</span>) &#123;<br>					System.out.println(<span class="hljs-string">&quot;销售了--&quot;</span> + tickets.remove(<span class="hljs-number">0</span>));<br>				&#125;<br>			&#125;).start();<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 有N张火车票，每张票都有一个编号</span><br><span class="hljs-comment"> * 同时有10个窗口对外售票</span><br><span class="hljs-comment"> * 请写一个模拟程序</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 分析下面的程序可能会产生哪些问题？</span><br><span class="hljs-comment"> *  </span><br><span class="hljs-comment"> * 使用Vector或者Collections.synchronizedXXX</span><br><span class="hljs-comment"> * 分析一下，这样能解决问题吗？</span><br><span class="hljs-comment"> * 内部非原子性操作，产生超卖问题</span><br><span class="hljs-comment"> * try &#123;</span><br><span class="hljs-comment"> *		TimeUnit.MILLISECONDS.sleep(10);</span><br><span class="hljs-comment"> *	&#125; catch (InterruptedException e) &#123;</span><br><span class="hljs-comment"> *	    e.printStackTrace();</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> java.util.Vector;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketSeller</span> </span>&#123;<br>	<span class="hljs-keyword">static</span> Vector&lt;String&gt; tickets = <span class="hljs-keyword">new</span> Vector&lt;&gt;();<br>	<br>	<br>	<span class="hljs-keyword">static</span> &#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">1000</span>; i++) tickets.add(<span class="hljs-string">&quot;票 编号：&quot;</span> + i);<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++) &#123;<br>			<span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>				<span class="hljs-keyword">while</span>(tickets.size() &gt; <span class="hljs-number">0</span>) &#123;<br>					<br>					<span class="hljs-keyword">try</span> &#123;<br>						TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">10</span>);<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>					<br>					<br>					System.out.println(<span class="hljs-string">&quot;销售了--&quot;</span> + tickets.remove(<span class="hljs-number">0</span>));<br>				&#125;<br>			&#125;).start();<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 有N张火车票，每张票都有一个编号</span><br><span class="hljs-comment"> * 同时有10个窗口对外售票</span><br><span class="hljs-comment"> * 请写一个模拟程序</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 分析下面的程序可能会产生哪些问题？</span><br><span class="hljs-comment"> * 重复销售？超量销售？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用Vector或者Collections.synchronizedXXX</span><br><span class="hljs-comment"> * 分析一下，这样能解决问题吗？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 就算操作A和B都是同步的，但A和B组成的复合操作也未必是同步的，仍然需要自己进行同步</span><br><span class="hljs-comment"> * 就像这个程序，判断size和进行remove必须是一整个的原子操作</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 结果正常，但是性能慢</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> java.util.LinkedList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketSeller</span> </span>&#123;<br>	<span class="hljs-keyword">static</span> List&lt;String&gt; tickets = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();<br>	<br>	<br>	<span class="hljs-keyword">static</span> &#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">1000</span>; i++) tickets.add(<span class="hljs-string">&quot;票 编号：&quot;</span> + i);<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++) &#123;<br>			<span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>				<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) &#123;<br>					<span class="hljs-keyword">synchronized</span>(tickets) &#123;<br>						<span class="hljs-keyword">if</span>(tickets.size() &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;<br>						<br>						<span class="hljs-keyword">try</span> &#123;<br>							TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">10</span>);<br>						&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>							e.printStackTrace();<br>						&#125;<br>						<br>						System.out.println(<span class="hljs-string">&quot;销售了--&quot;</span> + tickets.remove(<span class="hljs-number">0</span>));<br>					&#125;<br>				&#125;<br>			&#125;).start();<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 有N张火车票，每张票都有一个编号</span><br><span class="hljs-comment"> * 同时有10个窗口对外售票</span><br><span class="hljs-comment"> * 请写一个模拟程序</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 分析下面的程序可能会产生哪些问题？</span><br><span class="hljs-comment"> * 重复销售？超量销售？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用Vector或者Collections.synchronizedXXX</span><br><span class="hljs-comment"> * 分析一下，这样能解决问题吗？</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 就算操作A和B都是同步的，但A和B组成的复合操作也未必是同步的，仍然需要自己进行同步</span><br><span class="hljs-comment"> * 就像这个程序，判断size和进行remove必须是一整个的原子操作</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * 使用ConcurrentQueue提高并发性</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> java.util.Queue;<br><span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketSeller</span> </span>&#123;<br>	<span class="hljs-keyword">static</span> Queue&lt;String&gt; tickets = <span class="hljs-keyword">new</span> ConcurrentLinkedQueue&lt;&gt;();<br>	<br>	<br>	<span class="hljs-keyword">static</span> &#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">1000</span>; i++) tickets.add(<span class="hljs-string">&quot;票 编号：&quot;</span> + i);<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++) &#123;<br>			<span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>				<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>) &#123;<br>                    <span class="hljs-comment">//从队列头部取值，如果为空，返回null</span><br>					String s = tickets.poll();<br>					<span class="hljs-keyword">if</span>(s == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">break</span>;<br>					<span class="hljs-keyword">else</span> System.out.println(<span class="hljs-string">&quot;销售了--&quot;</span> + s);<br>				&#125;<br>			&#125;).start();<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="七、CopyOnWriteList"><a href="#七、CopyOnWriteList" class="headerlink" title="七、CopyOnWriteList"></a>七、CopyOnWriteList</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 写时复制容器 copy on write</span><br><span class="hljs-comment"> * 多线程环境下，写时效率低，读时效率高</span><br><span class="hljs-comment"> * 适合写少读多的环境</span><br><span class="hljs-comment"> * 复制一份，长度加1，写的时候加Synchronized锁</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> java.util.Vector;<br><span class="hljs-keyword">import</span> java.util.concurrent.CopyOnWriteArrayList;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CopyOnWriteList</span> </span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		List&lt;String&gt; lists = <br>				<span class="hljs-comment">//new ArrayList&lt;&gt;(); //这个会出并发问题！</span><br>				<span class="hljs-comment">//new Vector();</span><br>				<span class="hljs-keyword">new</span> CopyOnWriteArrayList&lt;&gt;();<br>		Random r = <span class="hljs-keyword">new</span> Random();<br>		Thread[] ths = <span class="hljs-keyword">new</span> Thread[<span class="hljs-number">100</span>];<br>		<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;ths.length; i++) &#123;<br>			Runnable task = <span class="hljs-keyword">new</span> Runnable() &#123;<br>	<br>				<span class="hljs-meta">@Override</span><br>				<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>					<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">1000</span>; i++) lists.add(<span class="hljs-string">&quot;a&quot;</span> + r.nextInt(<span class="hljs-number">10000</span>));<br>				&#125;<br>				<br>			&#125;;<br>			ths[i] = <span class="hljs-keyword">new</span> Thread(task);<br>		&#125;<br>		<br>		<br>		runAndComputeTime(ths);<br>		<br>		System.out.println(lists.size());<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">runAndComputeTime</span><span class="hljs-params">(Thread[] ths)</span> </span>&#123;<br>		<span class="hljs-keyword">long</span> s1 = System.currentTimeMillis();<br>		Arrays.asList(ths).forEach(t-&gt;t.start());<br>		Arrays.asList(ths).forEach(t-&gt;&#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				t.join();<br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				e.printStackTrace();<br>			&#125;<br>		&#125;);<br>		<span class="hljs-keyword">long</span> s2 = System.currentTimeMillis();<br>		System.out.println(s2 - s1);		<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="C:\Users\QianMo\AppData\Roaming\Typora\typora-user-images\1618332932928.png" alt="添加方法原理"></p>
<h5 id="八、BlockingQueue-阻塞队列-天生的生产者、消费者实现-使用park阻塞等待状态"><a href="#八、BlockingQueue-阻塞队列-天生的生产者、消费者实现-使用park阻塞等待状态" class="headerlink" title="八、BlockingQueue 阻塞队列  天生的生产者、消费者实现 使用park阻塞等待状态"></a>八、BlockingQueue 阻塞队列  天生的生产者、消费者实现 使用park阻塞等待状态</h5><p>Queue提供的常用方法</p>
<ul>
<li>offer 添加 相当于add 如果加好返回true，满了，没有加进去返回false，与list的add相比，如果加满了会报异常</li>
<li>peek 取值，并不会remove</li>
<li>poll 取值，并且remove</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs plain">import java.util.Queue;<br>import java.util.concurrent.ConcurrentLinkedQueue;<br><br>public class ConcurrentQueue &#123;<br>	public static void main(String[] args) &#123;<br>		Queue&lt;String&gt; strs &#x3D; new ConcurrentLinkedQueue&lt;&gt;();<br>		<br>		for(int i&#x3D;0; i&lt;10; i++) &#123;<br>			strs.offer(&quot;a&quot; + i);  &#x2F;&#x2F;add<br>		&#125;<br>		<br>		System.out.println(strs);<br>		<br>		System.out.println(strs.size());<br>		<br>		System.out.println(strs.poll());<br>		System.out.println(strs.size());<br>		<br>		System.out.println(strs.peek());<br>		System.out.println(strs.size());<br>		<br>		&#x2F;&#x2F;双端队列Deque<br>	&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<ul>
<li>LinkedBlockingQueue  无界(链表实现的BlockingQueue)没有长度限制</li>
</ul>
<p>put方法装，如果满了，会阻塞</p>
<p>take方法取，如果空了，会阻塞</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> java.util.concurrent.BlockingQueue;<br><span class="hljs-keyword">import</span> java.util.concurrent.LinkedBlockingQueue;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinkedBlockingQueue</span> </span>&#123;<br><br>	<span class="hljs-keyword">static</span> BlockingQueue&lt;String&gt; strs = <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;&gt;();<br><br>	<span class="hljs-keyword">static</span> Random r = <span class="hljs-keyword">new</span> Random();<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>				<span class="hljs-keyword">try</span> &#123;<br>					strs.put(<span class="hljs-string">&quot;a&quot;</span> + i); <span class="hljs-comment">//如果满了，就会等待</span><br>					TimeUnit.MILLISECONDS.sleep(r.nextInt(<span class="hljs-number">1000</span>));<br>				&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>					e.printStackTrace();<br>				&#125;<br>			&#125;<br>		&#125;, <span class="hljs-string">&quot;p1&quot;</span>).start();<br><br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>			<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>				<span class="hljs-keyword">for</span> (;;) &#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; take -&quot;</span> + strs.take()); <span class="hljs-comment">//如果空了，就会等待</span><br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>				&#125;<br>			&#125;, <span class="hljs-string">&quot;c&quot;</span> + i).start();<br><br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>ArrayBlockingQueue  有界</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> java.util.concurrent.ArrayBlockingQueue;<br><span class="hljs-keyword">import</span> java.util.concurrent.BlockingQueue;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArrayBlockingQueue</span> </span>&#123;<br><br>	<span class="hljs-keyword">static</span> BlockingQueue&lt;String&gt; strs = <span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="hljs-number">10</span>);<br><br>	<span class="hljs-keyword">static</span> Random r = <span class="hljs-keyword">new</span> Random();<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>			strs.put(<span class="hljs-string">&quot;a&quot;</span> + i);<br>		&#125;<br>		<br>		<span class="hljs-comment">//strs.put(&quot;aaa&quot;); //满了就会等待，程序阻塞</span><br>		<span class="hljs-comment">//strs.add(&quot;aaa&quot;); //满了就会报参数状态异常</span><br>		<span class="hljs-comment">//strs.offer(&quot;aaa&quot;); //返回值</span><br>		strs.offer(<span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-number">1</span>, TimeUnit.SECONDS); <span class="hljs-comment">//尝试1s钟后设置值</span><br>		<br>		System.out.println(strs);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>PriorityQueque </li>
<li>DelayQueue  时间角度排序</li>
<li>SynchronusQueue  两个线程间传递任务</li>
<li>TransferQueue 前面几种的组合</li>
</ul>
<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2021/04/06/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/04-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%AB%98%E5%B9%B6%E5%8F%91/">04.多线程与高并发 Next →</a><hr></div><div id="bottom-btn"><a id="to-top" href="#post-title" title="to top">∧</a></div><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: ''
 , appKey: ''
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://scpic.chinaz.net/files/pic/pic9/202104/apic31860.jpg" alt="Logo"></a><h1 id="Dr"><a href="/"> Dr.浅陌</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">7</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">2</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">2</span></div></section></div><div id="aside-block" style="order: -1"></div><footer style="text-align: right"><wbr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>